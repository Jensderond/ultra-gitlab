name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release_notes
        run: |
          # Find the previous tag
          CURRENT_TAG="${{ github.ref_name }}"
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^v' | sed -n '2p')

          if [ -z "$PREVIOUS_TAG" ]; then
            # First release â€” use all commits
            RANGE="HEAD"
          else
            RANGE="${PREVIOUS_TAG}..${CURRENT_TAG}"
          fi

          # Collect commits grouped by type
          FEATURES=""
          FIXES=""
          CHORES=""
          STYLES=""
          REFACTORS=""
          OTHER=""

          while IFS= read -r line; do
            # Skip empty lines
            [ -z "$line" ] && continue

            # Extract short hash and message
            HASH=$(echo "$line" | cut -d' ' -f1)
            MSG=$(echo "$line" | cut -d' ' -f2-)

            # Remove Co-Authored-By lines
            MSG=$(echo "$MSG" | sed '/^Co-Authored-By:/d' | head -1)

            ENTRY="- ${MSG} (\`${HASH}\`)"

            case "$MSG" in
              feat:*|feat\(*) FEATURES="${FEATURES}${ENTRY}"$'\n' ;;
              fix:*|fix\(*)   FIXES="${FIXES}${ENTRY}"$'\n' ;;
              chore:*|chore\(*) CHORES="${CHORES}${ENTRY}"$'\n' ;;
              style:*|style\(*) STYLES="${STYLES}${ENTRY}"$'\n' ;;
              refactor:*|refactor\(*) REFACTORS="${REFACTORS}${ENTRY}"$'\n' ;;
              *)              OTHER="${OTHER}${ENTRY}"$'\n' ;;
            esac
          done <<< "$(git log --pretty=format:'%h %s' $RANGE)"

          # Build the release body
          BODY=""

          if [ -n "$FEATURES" ]; then
            BODY="${BODY}## âœ¨ Features"$'\n\n'"${FEATURES}"$'\n'
          fi
          if [ -n "$FIXES" ]; then
            BODY="${BODY}## ðŸ› Bug Fixes"$'\n\n'"${FIXES}"$'\n'
          fi
          if [ -n "$REFACTORS" ]; then
            BODY="${BODY}## â™»ï¸ Refactoring"$'\n\n'"${REFACTORS}"$'\n'
          fi
          if [ -n "$STYLES" ]; then
            BODY="${BODY}## ðŸŽ¨ Styling"$'\n\n'"${STYLES}"$'\n'
          fi
          if [ -n "$CHORES" ]; then
            BODY="${BODY}## ðŸ”§ Maintenance"$'\n\n'"${CHORES}"$'\n'
          fi
          if [ -n "$OTHER" ]; then
            BODY="${BODY}## ðŸ“¦ Other Changes"$'\n\n'"${OTHER}"$'\n'
          fi

          # Add comparison link
          if [ -n "$PREVIOUS_TAG" ]; then
            REPO_URL="${{ github.server_url }}/${{ github.repository }}"
            BODY="${BODY}"$'\n'"**Full Changelog**: [${PREVIOUS_TAG}...${CURRENT_TAG}](${REPO_URL}/compare/${PREVIOUS_TAG}...${CURRENT_TAG})"
          fi

          # Set multiline output
          {
            echo "body<<RELEASE_NOTES_EOF"
            echo "$BODY"
            echo "RELEASE_NOTES_EOF"
          } >> "$GITHUB_OUTPUT"

          echo "Generated release notes:"
          echo "$BODY"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Ultra GitLab ${{ github.ref_name }}'
          releaseBody: ${{ steps.release_notes.outputs.body }}
          releaseDraft: true
          prerelease: false
          args: --target aarch64-apple-darwin
