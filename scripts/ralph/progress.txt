# Ralph Progress Log
Started: Wed Feb 11 21:22:47 CET 2026

## Codebase Patterns
- Migrations use `CREATE TABLE IF NOT EXISTS` and `CREATE INDEX IF NOT EXISTS`
- Migration files: `src-tauri/src/db/migrations/NNNN_name.sql`
- Register migrations in `MIGRATIONS` array in `src-tauri/src/db/mod.rs` via `include_str!`
- Composite FK references (e.g., `FOREIGN KEY (a, b) REFERENCES table(a, b)`) are supported
- Models: derive `Debug, Clone, Serialize, Deserialize, FromRow` with `#[serde(rename_all = "camelCase")]`
- DB queries: functions take `&DbPool`, return `Result<T, AppError>`
- Commands: `#[tauri::command]` with `pool: State<'_, DbPool>`, return `Result<T, AppError>`
- 3 registrations for new commands: commands/<file>.rs, commands/mod.rs, lib.rs generate_handler!
- Project model in `src-tauri/src/models/project.rs` has `upsert_project()` and `get_project()`
- Sidebar: `navItems` array in `AppSidebar.tsx`, items with `bottom: true` go to bottom section
- Keyboard shortcuts: 3 places to register — `App.tsx` (handler), `commands/registry.ts` (CommandId + definition), `config/shortcuts.ts` (help overlay)
- Command palette: actions bound via `actionMap` in `AppContent()` useMemo
- Page instance pattern: `listInstances()` from `services/gitlab.ts`, useState for `selectedInstanceId`, auto-select first on mount
- Pipeline status badges: CSS classes `.pipeline-badge--{status}`, card left-border accent `.pipeline-card--{status}`
- PipelineStatus timestamps are ISO 8601 strings (not Unix like MR fields)

---

## 2026-02-11 - US-001
- Created migration `0010_create_pipeline_projects.sql` with pipeline_projects table
- Composite PK (project_id, instance_id), FK to projects(id, instance_id) and gitlab_instances(id)
- Registered in MIGRATIONS array in db/mod.rs
- Files changed: `src-tauri/src/db/migrations/0010_create_pipeline_projects.sql`, `src-tauri/src/db/mod.rs`
- **Learnings for future iterations:**
  - The projects table already has composite PK `(id, instance_id)` so FK references must use both columns
  - Migration parser handles semicolons inside parentheses correctly
---

## 2026-02-11 - US-002
- Created `PipelineProject` model in `src-tauri/src/models/pipeline_project.rs`
- Model includes joined project metadata fields (name, name_with_namespace, path_with_namespace, web_url)
- DB queries: `list_pipeline_projects`, `upsert_pipeline_project`, `toggle_pin`, `remove_pipeline_project`
- Registered model in `models/mod.rs`
- Files changed: `src-tauri/src/models/pipeline_project.rs`, `src-tauri/src/models/mod.rs`
- **Learnings for future iterations:**
  - project.rs uses `sqlx::Error` directly (not `AppError`) for return types — follow same pattern for consistency
  - JOIN queries work with `sqlx::query_as` as long as the struct fields match the SELECT columns in order
  - `datetime('now')` returns ISO 8601 text in SQLite, matching our TEXT column type
---

## 2026-02-11 - US-003
- Created `commands/pipeline.rs` with 4 commands: list, visit, toggle_pin, remove
- `visit_pipeline_project` checks project cache, fetches from GitLab API if missing, then upserts
- Helper `create_gitlab_client` follows same pattern as mr.rs
- Registered in commands/mod.rs and lib.rs generate_handler!
- Files changed: `src-tauri/src/commands/pipeline.rs`, `src-tauri/src/commands/mod.rs`, `src-tauri/src/lib.rs`
- **Learnings for future iterations:**
  - `GitLabProject` (API response) is in `services::gitlab_client`, converts to `models::Project` for DB storage
  - Reuse `create_gitlab_client` helper for any pipeline command needing API access
---

## 2026-02-11 - US-004
- Added `search_projects` command in `commands/pipeline.rs`
- Added `search_projects` method to `GitLabClient` in `services/gitlab_client.rs`
- Created `ProjectSearchResult` DTO with camelCase serde
- Local LIKE search on `name_with_namespace`, then GitLab API fallback if < 5 results
- API results cached via `upsert_project`, deduplicated by project ID
- Files changed: `src-tauri/src/commands/pipeline.rs`, `src-tauri/src/commands/mod.rs`, `src-tauri/src/lib.rs`, `src-tauri/src/services/gitlab_client.rs`
- **Learnings for future iterations:**
  - GitLab client uses `self.client.get(&url).query(&[...]).send()` for query params
  - `HashSet::insert` returns `true` if the value was new — useful for dedup
---

## 2026-02-11 - US-005
- Added `PipelineStatus` DTO and `get_pipeline_statuses` command in `commands/pipeline.rs`
- Added `GitLabPipeline` struct and `get_latest_pipeline` method in `services/gitlab_client.rs`
- Uses `futures::future::join_all` for parallel pipeline fetching
- SHA truncated to 8 chars; added `futures` crate
- **Learnings for future iterations:**
  - GitLab `ref` field needs `#[serde(rename = "ref")]` on `ref_name`
  - `join_all` from futures crate for dynamic vec of futures
---

## 2026-02-11 - US-006
- Already implemented in previous commit (90cf1d8), just marked as passing
- All types, service wrappers, and re-exports were already in place
---

## 2026-02-11 - US-007
- Created `PipelinesPage` placeholder component in `src/pages/PipelinesPage.tsx` with CSS
- Added `/pipelines` route in `App.tsx`
- Added Pipeline icon and sidebar entry in `AppSidebar.tsx` between My MRs and Settings
- Added `Cmd+I` / `Ctrl+I` keyboard shortcut in `App.tsx`
- Added `GoToPipelines` command in `commands/registry.ts` (CommandId + definition)
- Added `go-to-pipelines` shortcut in `config/shortcuts.ts` for keyboard help overlay
- Files changed: `src/pages/PipelinesPage.tsx`, `src/pages/PipelinesPage.css`, `src/App.tsx`, `src/components/AppSidebar/AppSidebar.tsx`, `src/commands/registry.ts`, `src/config/shortcuts.ts`, `scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - Sidebar nav items: `navItems` array in `AppSidebar.tsx`, `bottom: true` for bottom-aligned items
  - Keyboard shortcuts need 3 registrations: App.tsx handler, commands/registry.ts, config/shortcuts.ts
  - Command palette actions bound in `AppContent()` via `actionMap` useMemo
---

## 2026-02-11 - US-008
- Built full PipelinesPage with project cards in responsive CSS grid layout
- Each card shows: project name (with namespace), pipeline status badge (color-coded), branch/ref, SHA, duration, relative time
- Status badges: green (success), red (failed), blue (running), amber (pending), gray (canceled/skipped)
- Running pipelines show a pulse animation on the badge dot
- Pinned projects appear first in a "Pinned" section with pin icon; recent projects in "Recent" section
- Empty state shown when no projects tracked, with prompt to use search
- Instance selector follows same pattern as MyMRsPage (auto-select first, dropdown if multiple)
- "Updated X ago" freshness timestamp in header
- Files changed: `src/pages/PipelinesPage.tsx`, `src/pages/PipelinesPage.css`, `scripts/ralph/prd.json`
- **Learnings for future iterations:**
  - PipelineStatus timestamps are ISO 8601 strings (not Unix timestamps like MR fields) — need ISO-aware `formatRelativeTime`
  - Page layout pattern: header with `padding: 24px 32px`, scrollable content area with `flex: 1 1 0; min-height: 0; overflow-y: auto`
  - Status colors: use CSS variables `--success-color`, `--error-color`, `--accent-color` (blue for running), `--warning-color`
  - Grid: `repeat(auto-fill, minmax(260px, 1fr))` gives good responsive behavior for cards
  - `listInstances` is in `services/gitlab.ts`, pipeline commands are in `services/tauri.ts`
---
