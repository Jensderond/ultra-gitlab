# Ralph Progress Log
Started: Sat Feb 28 13:44:49 CET 2026

## Codebase Patterns
- `generate_local_id()` in `commands/comments.rs` uses a static AtomicI64 counter combined with millisecond timestamps for unique negative IDs
- Rust tests live in `#[cfg(test)] mod tests` at the bottom of each file, run with `cargo test --lib module::path::tests`
- Working directory for cargo commands must be project root (`/Users/jens/Sites/ultra-gitlab`), not `src-tauri/`
- `gitlab_instances.token` is nullable (`TEXT` without `NOT NULL`) — always handle as `Option<String>`
- `SyncProgressPayload.total` is `Option<i64>`, not `u32`
- `sync_processor::process_action` can be called directly instead of through `retry_failed_actions` when you need per-instance client control
---

## 2026-02-28 - US-001
- Replaced `generate_local_id()` which returned `-now()` (second precision) with millisecond timestamp * 65536 + atomic counter
- Added `AtomicI64` static counter `LOCAL_ID_COUNTER` for sub-millisecond uniqueness
- Added tests: tight-loop uniqueness (100 calls), cross-thread uniqueness (2 threads × 10 calls)
- Files changed: `src-tauri/src/commands/comments.rs`
- **Learnings for future iterations:**
  - `cargo check` / `cargo test` must be run from the project root, not from `src-tauri/`
  - Unused Arc import caused a warning — clean up imports before final check
---

## 2026-02-28 - US-002
- Rewrote `retry_failed_actions` in `commands/sync.rs` to query per-instance credentials
- Replaced single-instance `ORDER BY id LIMIT 1` query with a JOIN across `sync_queue → merge_requests → gitlab_instances`
- Added `ActionWithInstance` helper struct for the joined query result
- Actions are grouped by `instance_id`, each group gets its own `GitLabClient`
- Orphaned actions (deleted instance or MR) are detected via a LEFT JOIN query and marked as `discarded`
- Missing tokens emit `AUTH_EXPIRED_EVENT` and mark group actions as failed
- Files changed: `src-tauri/src/commands/sync.rs`
- **Learnings for future iterations:**
  - `gitlab_instances.token` is nullable — use `Option<String>` in query structs
  - `SyncProgressPayload.total` expects `Option<i64>`, not `u32`
  - `sync_processor::process_action` is the lower-level function that takes a single client + action — useful when you need per-instance control
---
