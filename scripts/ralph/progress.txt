# Ralph Progress Log
Started: Sat Feb 28 14:18:43 CET 2026
---

## Codebase Patterns
- Frontend hooks use module-level variables (e.g., `coldStartHandled`, `handledUrls`) for state that must survive across React effect re-runs (strict mode, HMR)
- Race conditions in async handlers: use cancellation flags (`let cancelled = false`) in useEffect cleanup
- Typecheck: `bunx tsc --noEmit`

## 2026-02-28 - US-001
- Added module-level `const handledUrls = new Set<string>()` to `src/hooks/useDeepLink.ts`
- In focus handler, check `handledUrls.has(url)` before processing; after `await handleDeepLinkUrl(url)`, call `handledUrls.add(url)`
- Files changed: `src/hooks/useDeepLink.ts`
- **Learnings for future iterations:**
  - The existing `processingRef` guards concurrent calls within a single focus event, but `handledUrls` is needed to prevent the same URL being re-processed across multiple focus events
  - Cold-start path intentionally left unchanged (uses `coldStartHandled` flag, not `handledUrls`)
---

## 2026-02-28 - US-002
- Fixed `handleDeleteComment` in `src/pages/MRDetailPage/index.tsx` to capture the comment before optimistic removal
- On API failure, restores via `addComment(toRestore)` (reuses existing `addComment` from `useFileComments`)
- Files changed: `src/pages/MRDetailPage/index.tsx`
- **Learnings for future iterations:**
  - `useFileComments` exposes `addComment` which can be used as a restore mechanism (appends to state)
  - Added `fileComments` and `addComment` to `handleDeleteComment` useCallback deps
---

## 2026-02-28 - US-003
- Fixed `currentUser` resolution in 3 files to use the instance matching `mrData.instanceId` instead of `instances[0]`
- `src/pages/MyMRDetailPage/useMyMRData.ts`: find instance by `inst.id === mrData.instanceId` after MR data loads
- `src/hooks/useActivityData.ts`: added `getMergeRequestById` import; now fetches MR alongside comments to get `instanceId`
- `src/pages/MRDetailPage/index.tsx`: effect now depends on `mr` and finds matching instance by `mr.instanceId`
- Files changed: `src/pages/MyMRDetailPage/useMyMRData.ts`, `src/hooks/useActivityData.ts`, `src/pages/MRDetailPage/index.tsx`
- **Learnings for future iterations:**
  - `MergeRequest` type has `instanceId: number` field
  - `GitLabInstance` type has `id: number` and `authenticatedUsername: string | null`
  - `getMergeRequestById` is available in `services/gitlab.ts` for fetching MR by local DB id
---

## 2026-02-28 - US-004
- Fixed `effectiveLoading` in `src/hooks/useFileContent.ts` line 247
- Added `&& mr !== null && diffRefs !== null` guard to the stale-content detection clause
- Files changed: `src/hooks/useFileContent.ts`
- **Learnings for future iterations:**
  - `useFileContent` has two loading mechanisms: `isLoading` (async fetch) and `effectiveLoading` (stale detection)
  - The stale detection clause must be gated on valid `mr`/`diffRefs` or it keeps loading forever on error paths
---

## 2026-02-28 - US-005
- Added `rebaseTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null)` to `MergeSection`
- Changed `setTimeout(...)` to `rebaseTimerRef.current = setTimeout(...)`
- Added cleanup `useEffect` that calls `clearTimeout(rebaseTimerRef.current)` on unmount
- Files changed: `src/pages/MyMRDetailPage/MergeSection.tsx`
---

## 2026-02-28 - US-006
- Added `instanceIdRef = useRef(instanceId)` to `MRList.tsx` that's updated on every render
- Captured `requestedInstanceId = instanceId` at start of `loadMRs`
- After `await listMergeRequests(...)`, guard with `if (instanceIdRef.current !== requestedInstanceId) return;`
- Files changed: `src/components/MRList/MRList.tsx`
- **Learnings for future iterations:**
  - Race condition pattern: use a ref that always tracks current prop value; capture at call start; compare after await
  - MRList uses useCallback with `[instanceId, onMRsLoaded]` deps, so new callback is created when instance changes but old async ops may still be in flight
---

## 2026-02-28 - US-007
- Added `let cancelled = false` and `return () => { cancelled = true; }` to `loadComments` useEffect in `useFileComments.ts`
- Added `if (cancelled) return;` after the await and before each state setter
- Files changed: `src/pages/MRDetailPage/useFileComments.ts`
---

## 2026-02-28 - US-008
- Added `selectedInstanceIdRef` to `usePipelinesData.ts` tracking current selected instance
- In `loadProjects`: captured `requestedInstanceId = state.selectedInstanceId`, checked `selectedInstanceIdRef.current !== requestedInstanceId` after each await
- In `refreshStatuses`: same pattern
- Files changed: `src/pages/PipelinesPage/usePipelinesData.ts`
---

## 2026-02-28 - US-009
- Added `useEffect` that resets files, selectedFile, generatedPaths, diffRefs, fileFocusIndex, codeTabLoaded when mrId changes
- Added `let cancelled = false; return () => { cancelled = true; }` to `loadCodeData` useEffect
- Added `if (cancelled) return;` after each Promise.all await
- Files changed: `src/pages/MyMRDetailPage/useCodeTab.ts`
---
