{
  "project": "Ultra GitLab",
  "branchName": "ralph/themes",
  "description": "Theme & Appearance Customization - Preset themes (Kanagawa Wave, Kanagawa Light, Loved), custom colorway creation, font selection, with Monaco and tree-sitter adaptation",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create ThemeDefinition type and Kanagawa Wave theme data",
      "description": "As a developer, I need a ThemeDefinition TypeScript interface and a Kanagawa Wave data file so the theme system has a structured format to work with.",
      "acceptanceCriteria": [
        "Create src/themes/ directory with types.ts defining a ThemeDefinition interface",
        "ThemeDefinition covers all CSS variable groups: backgrounds (primary, secondary, tertiary, hover, selected), text (primary, secondary, tertiary, muted), borders, accents/primary, focus, links, status colors (error, success, warning, info — each with color, bg, text, light variants), diff colors (add/remove bg, hover, gutter, text + gutter-bg, hunk-header), labels, card, input/disabled/code backgrounds",
        "ThemeDefinition includes extended palette slots for unique colors currently in --kw-* variables: sakura-pink, spring-green, carp-yellow, boat-yellow, ronin-yellow, surimi-orange, peach, crystal-blue, spring-blue, fuji-gray, winter-blue, wave-glow, wave-glow-strong",
        "ThemeDefinition includes a monacoTokenColors section with entries for: comment, keyword, string, number, type, function, variable, operator, constant, tag, attribute, punctuation, plus editor UI colors (editor background, foreground, selection, lineHighlight, gutter)",
        "ThemeDefinition includes a syntaxHighlight section with entries for: keyword, string, comment, function, type, variable, number, operator, punctuation, tag, attribute, constant, property",
        "ThemeDefinition includes metadata: id (string), name (string), type ('dark' | 'light')",
        "Create src/themes/kanagawa-wave.ts exporting a ThemeDefinition with all current color values extracted from App.css :root and MRDetailPage.css --kw-* variables",
        "Create src/themes/index.ts barrel exporting types and theme",
        "bunx tsc --noEmit passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Consolidate --kw-* CSS variables into main variable set",
      "description": "As a developer, I need the duplicate --kw-* CSS variables merged into the main set so we have one unified set of variables for the theme system to control.",
      "acceptanceCriteria": [
        "Map each --kw-* variable to its standard equivalent: --kw-bg-dark → --bg-secondary, --kw-bg-default → --bg-primary, --kw-bg-dim → --bg-dim, --kw-bg-highlight → --bg-tertiary, --kw-bg-gutter → --gutter-bg, --kw-fg-default → --text-primary, --kw-fg-dim → --text-secondary, --kw-fg-muted → --text-tertiary, --kw-fg-comment → --text-muted, --kw-wave-blue → --accent-color, --kw-wave-cyan → --accent-hover, --kw-sumi-ink → --border-color, --kw-autumn-red → --error-color, --kw-spring-green → --success-color, --kw-carpYellow → --warning-color",
        "Add new standard CSS variables for unique --kw-* colors that have no existing equivalent: --accent-pink (sakura-pink #d27e99), --accent-green (spring-blue #7aa89f), --accent-crystal (#a3d4d5), --accent-warm-yellow (#c0a36e), --accent-ronin (#ff9e3b), --accent-orange (#ffa066), --accent-peach (#e46876), --bg-winter (#252535), --text-fuji (#54546d), --wave-glow (rgba), --wave-glow-strong (rgba)",
        "Replace all --kw-* variable usages across all CSS files (MRDetailPage.css, MRListPage.css, Settings.css, MyMRsPage.css, PipelinesPage.css, MyMRDetailPage.css) with their standard equivalents",
        "Remove the duplicate :root block in MRDetailPage.css (lines 7-45) and the duplicate @import url for Google Fonts (line 4)",
        "Add the new standard variables to the :root block in App.css",
        "App looks identical after this refactor — no visual changes",
        "bunx tsc --noEmit passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Convert tree-sitter syntax.css to CSS variables",
      "description": "As a developer, I need the hardcoded hex colors in syntax.css replaced with CSS variables so the theme system can control syntax highlighting.",
      "acceptanceCriteria": [
        "Replace all hardcoded hex color values in src/styles/syntax.css with CSS variables (e.g., --syntax-keyword, --syntax-string, --syntax-comment, --syntax-function, --syntax-type, --syntax-variable, --syntax-number, --syntax-operator, --syntax-punctuation, --syntax-tag, --syntax-attribute, --syntax-constant, --syntax-property)",
        "Add corresponding CSS variable declarations to the :root block in App.css with the current color values as defaults",
        "Syntax highlighting looks identical after this change",
        "bunx tsc --noEmit passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create useTheme hook and wire dynamic theme application",
      "description": "As a developer, I need a useTheme hook that applies a ThemeDefinition to :root CSS variables at runtime so themes can be swapped dynamically.",
      "acceptanceCriteria": [
        "Create src/hooks/useTheme.ts with a useTheme() hook that reads the active theme from a React context or state",
        "Create a ThemeProvider component that wraps the app and provides theme context",
        "On mount and theme change, the provider applies all ThemeDefinition CSS variable values to document.documentElement.style (`:root`)",
        "Also applies syntax highlight variables (--syntax-keyword etc.) from the ThemeDefinition",
        "Remove hardcoded color values from the :root block in App.css — only keep font and layout properties, not colors (the ThemeProvider sets colors dynamically)",
        "Kanagawa Wave is the default theme, loaded on startup",
        "ThemeProvider mounted in App.tsx wrapping the app content",
        "App looks identical after this change — Kanagawa Wave colors applied dynamically instead of via CSS",
        "bunx tsc --noEmit passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Generate Monaco editor theme from active ThemeDefinition",
      "description": "As a developer, I need the Monaco editor theme generated from the active ThemeDefinition so it adapts when themes change.",
      "acceptanceCriteria": [
        "Create a utility function (e.g., in src/themes/monacoAdapter.ts) that converts a ThemeDefinition's monacoTokenColors into a Monaco IStandaloneThemeData object",
        "Wherever Monaco is initialized (find the current usage of kanagawaTheme.ts), replace the hardcoded theme import with a call to the adapter using the active ThemeDefinition",
        "The Monaco theme re-registers via monaco.editor.defineTheme() and applies via monaco.editor.setTheme() when the app theme changes",
        "The old hardcoded src/components/Monaco/kanagawaTheme.ts file is deleted or replaced with the adapter",
        "Monaco editor looks identical with Kanagawa Wave theme active",
        "bunx tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create Kanagawa Light theme preset",
      "description": "As a user who prefers light themes, I want a Kanagawa Light option so the app is comfortable in bright environments.",
      "acceptanceCriteria": [
        "Create src/themes/kanagawa-light.ts exporting a ThemeDefinition with id 'kanagawa-light', name 'Kanagawa Light', type 'light'",
        "Use warm off-white backgrounds (#f2ecbc or similar Kanagawa Lotus palette), dark text, and wave-blue accents",
        "Includes all extended palette colors adapted for light background",
        "Includes Monaco token colors suitable for light background (dark keywords, colored strings, gray comments)",
        "Includes syntax highlight colors suitable for light background",
        "Diff view add/remove colors are distinguishable on light background",
        "Re-export from src/themes/index.ts",
        "bunx tsc --noEmit passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create Loved theme preset",
      "description": "As a user, I want the Loved dark theme as an alternative colorway to Kanagawa Wave.",
      "acceptanceCriteria": [
        "Create src/themes/loved.ts exporting a ThemeDefinition with id 'loved', name 'Loved', type 'dark'",
        "Use Loved palette: backgrounds #121926 (primary) / #17202f (secondary), text #c0c5ce (primary) / #99a4b8 (secondary), accent #99beff",
        "Status colors from Loved palette: error #e05252, success #97a38f, warning #eabe9a",
        "Extended palette slots filled with Loved colors: pink #ea7599, purple #b18bb1, turquoise #7ea9a9, blue #6e94b9, orange #f7987e, brown #a67868",
        "Includes Monaco token colors using Loved's syntax palette",
        "Includes syntax highlight colors using Loved's palette",
        "Re-export from src/themes/index.ts",
        "bunx tsc --noEmit passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Update Settings type and persistence for theme IDs and font",
      "description": "As a developer, I need the Settings type updated to store a theme ID and font choice so user preferences can persist.",
      "acceptanceCriteria": [
        "Update the Theme type in src/types/index.ts from 'light' | 'dark' | 'system' to 'kanagawa-wave' | 'kanagawa-light' | 'loved' | 'custom'",
        "Add a uiFont field to the Settings interface: uiFont: string (default 'Noto Sans JP')",
        "Update setTheme() in src/services/storage.ts to accept the new theme ID type",
        "Add setUiFont(font: string) function to storage service (or reuse existing settings update pattern)",
        "Ensure default settings use 'kanagawa-wave' as theme and 'Noto Sans JP' as uiFont",
        "If there's a Rust backend Settings struct, update it to match (add ui_font field, update theme field)",
        "bunx tsc --noEmit passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add Appearance section with theme selector to Settings page",
      "description": "As a user, I want an Appearance section in Settings where I can pick a theme from visual swatches.",
      "acceptanceCriteria": [
        "New 'Appearance' section in the Settings page, placed before the Notifications section",
        "Section heading 'Appearance' consistent with other section headings",
        "Theme selector shows visual preview cards/swatches for each preset: Kanagawa Wave, Kanagawa Light, Loved",
        "Each swatch shows the theme's background color, a text sample in the theme's text color, and an accent color dot",
        "Currently active theme has a highlighted border or visual indicator",
        "Clicking a swatch applies the theme immediately via the ThemeProvider (no save button needed)",
        "Selected theme persists across app restarts via the Settings store",
        "useTheme hook reads the persisted theme ID on startup and applies it",
        "bunx tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add font selection to Appearance section",
      "description": "As a user, I want to choose the UI font so the app matches my reading preferences.",
      "acceptanceCriteria": [
        "Font selector dropdown or list added to the Appearance section below the theme swatches",
        "Options: 'Noto Sans JP' (default), 'Inter', 'SF Pro' (system -apple-system), 'System Default' (system-ui)",
        "Each option renders its name in that font for instant visual comparison",
        "Selecting a font applies it immediately to all UI text (updates font-family on :root)",
        "Monospace font (IBM Plex Mono) remains unchanged for code/technical elements",
        "On startup, lazy-load only the user's saved font via Google Fonts link element. When Appearance section opens, background-load remaining fonts",
        "Font choice persists across restarts via the Settings store (uiFont field)",
        "bunx tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create palette derivation utility for custom themes",
      "description": "As a developer, I need a utility that derives a full ThemeDefinition from 3 input colors (background, text, accent) using HSL manipulation.",
      "acceptanceCriteria": [
        "Create src/themes/deriveTheme.ts with a function deriveTheme(bg: string, text: string, accent: string): ThemeDefinition",
        "Derives 3 background shades from the input bg color via lightness shifts",
        "Derives 4 text shades from the input text color via opacity/lightness shifts",
        "Derives hover, selected, and border colors from bg color",
        "Derives accent variants (hover, bg, primary, primary-hover, primary-dark) from the accent color",
        "Generates status colors: rotates accent hue to produce error (red range), success (green range), warning (yellow range), info (blue range) — each with color, bg (low opacity), text, light variants",
        "Generates diff colors from the derived success/error colors with appropriate opacity",
        "Derives extended palette slots (pink, orange, yellow variants, etc.) by hue rotation from accent",
        "For Monaco token colors and syntax highlighting: selects the nearest preset's tokens based on background luminance (dark bg → Kanagawa Wave tokens, light bg → Kanagawa Light tokens)",
        "Sets metadata: id 'custom', name 'Custom', type determined by bg luminance",
        "Pure function with no side effects, uses only HSL math (no external libraries)",
        "bunx tsc --noEmit passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Add custom theme creation UI",
      "description": "As a user, I want to create my own color scheme by picking 3 key colors so the app matches my personal taste.",
      "acceptanceCriteria": [
        "'Create Custom Theme' button in the Appearance section, below the preset swatches",
        "Clicking it reveals a compact inline editor with 3 color pickers: Background, Text, Accent",
        "Color pickers can use native <input type='color'> elements",
        "As the user picks colors, the theme updates live via deriveTheme() and the ThemeProvider",
        "A 'Save' button saves the custom theme — it then appears as a fourth swatch alongside presets",
        "A 'Delete' button removes the saved custom theme and reverts to the previous preset",
        "An 'Edit' button on the saved custom swatch re-opens the color picker editor",
        "Only one custom theme is supported at a time",
        "Custom theme colors (bg, text, accent) persist in Settings store and are re-derived on startup",
        "bunx tsc --noEmit passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    }
  ]
}
