## Codebase Patterns
<!-- Consolidated learnings - check this FIRST before starting work -->

### Architecture
- Database layer is in `src-tauri/src/db/` with pool.rs for connection management and mod.rs for initialization/migrations
- SQL migrations are stored in `src-tauri/src/db/migrations/` as .sql files
- Migration tracking uses a `_migrations` table in SQLite
- Models are in `src-tauri/src/models/` with one file per entity and mod.rs for re-exports
- All models derive `Serialize`, `Deserialize`, and `FromRow` for Tauri IPC and SQLx compatibility

### Conventions
- Use `Path` instead of `PathBuf` for function parameters per Clippy recommendation
- SQL statements in migrations must be parsed carefully - semicolons inside parentheses (e.g., `strftime('%s', 'now')`) don't end statements
- All database tests use `tempfile` crate for isolated test databases

### Gotchas
- SQLite doesn't support executing multiple statements in a single query - must split and execute individually
- When splitting SQL by `;`, need to track parenthesis depth to avoid splitting inside DEFAULT expressions

---

## 2026-01-30 - T006, T007, T008
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created SQLite migration file with all 7 tables from data-model.md:
  - gitlab_instances, merge_requests, diffs, diff_files, comments, sync_queue, sync_log
- Implemented database initialization with migration runner in db/mod.rs
- Created SQLite connection pool with WAL mode in db/pool.rs
- Added tests for database initialization and idempotent migrations

### Files Changed
- src-tauri/src/db/migrations/0001_initial_schema.sql (new)
- src-tauri/src/db/mod.rs (updated)
- src-tauri/src/db/pool.rs (new)
- src-tauri/Cargo.toml (added tempfile dev dependency)
- specs/001-local-mr-review/tasks.md (marked T006-T008 complete)

### Learnings for Future Iterations
- SQLite migration parsing requires tracking parenthesis depth to handle DEFAULT expressions with semicolons
- Clippy prefers `&Path` over `&PathBuf` for function parameters
- Tests use tempfile::tempdir() for isolated database testing

---

## 2026-01-30 - T009, T010, T011, T012, T013, T014
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created all Rust model files matching data-model.md entities:
  - GitLabInstance with URL normalization
  - MergeRequest with state/approval enums and JSON field parsing
  - Diff and DiffFile with change type handling
  - Comment with inline/reply/general classification
  - SyncAction and SyncLog with status enums and retry logic
- All models derive Serialize (for Tauri IPC) and FromRow (for SQLx)
- Added comprehensive unit tests for all models

### Files Changed
- src-tauri/src/models/gitlab_instance.rs (new)
- src-tauri/src/models/merge_request.rs (new)
- src-tauri/src/models/diff.rs (new)
- src-tauri/src/models/comment.rs (new)
- src-tauri/src/models/sync_action.rs (new)
- src-tauri/src/models/mod.rs (updated with exports)
- specs/001-local-mr-review/tasks.md (marked T009-T014 complete)

### Learnings for Future Iterations
- Model enums use `From<&str>` trait for parsing database strings
- JSON fields (labels, reviewers) are stored as strings and parsed on demand
- SQLx FromRow requires field names to match column names exactly

---

## 2026-01-30 - T015
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created AppError enum with all error variants needed for Tauri IPC
- Added Serialize impl using tagged enum format for frontend consumption
- Added From impls for sqlx::Error, reqwest::Error, serde_json::Error, and DbError
- Added builder methods for each error variant with optional context

### Files Changed
- src-tauri/src/error.rs (new)
- src-tauri/src/lib.rs (added error module)
- specs/001-local-mr-review/tasks.md (marked T015 complete)

### Learnings for Future Iterations
- Use `#[serde(tag = "type", content = "details")]` for tagged enum serialization
- Use `#[serde(skip_serializing_if = "Option::is_none")]` to omit optional fields when None

---

## 2026-01-30 - T016, T017, T018
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created GitLabClient with reqwest for GitLab API v4
- Added PRIVATE-TOKEN header authentication
- Implemented pagination parsing from X-Page, X-Total-Pages headers
- Added get_all_pages helper for fetching complete paginated results
- Created API types: GitLabMergeRequest, GitLabDiffVersion, GitLabDiscussion, etc.
- Implemented MR listing, diff fetching, discussions, approvals, and comments

### Files Changed
- src-tauri/src/services/gitlab_client.rs (new)
- src-tauri/src/services/mod.rs (updated with gitlab_client export)
- specs/001-local-mr-review/tasks.md (marked T016-T018 complete)

### Learnings for Future Iterations
- GitLab pagination uses X-Page, X-Per-Page, X-Total, X-Total-Pages, X-Next-Page headers
- Can't define structs inside impl blocks in Rust - move them outside
- Use `#[derive(Serialize)]` with `#[serde(skip_serializing_if = "Option::is_none")]` for optional query params

---

## 2026-01-30 - T019, T020
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added `keyring` crate v3 for cross-platform credential storage
- Created CredentialService with store/get/delete/has_token operations
- Uses OS keychain (Keychain on macOS, Credential Manager on Windows, Secret Service on Linux)
- URL normalization for consistent account identifiers

### Files Changed
- src-tauri/Cargo.toml (added keyring dependency)
- src-tauri/src/services/credentials.rs (new)
- src-tauri/src/services/mod.rs (added credentials export)
- specs/001-local-mr-review/tasks.md (marked T019-T020 complete)

### Learnings for Future Iterations
- Use `keyring` crate (not a Tauri plugin) for OS keychain access
- keyring::Error::NoEntry for missing credentials - handle for idempotent operations
- SERVICE_NAME constant used across all credential operations for consistency

---

## 2026-01-30 - T021, T022, T023, T024
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created setup_gitlab_instance command: validates token, stores in keychain, inserts to DB
- Created get_gitlab_instances command: lists all instances with token status
- Created delete_gitlab_instance command: removes from keychain and DB (with cascade)
- Registered all auth commands in lib.rs with proper database setup
- Database pool is initialized in Tauri setup hook and managed via app state

### Files Changed
- src-tauri/src/commands/auth.rs (new)
- src-tauri/src/commands/mod.rs (updated with auth exports)
- src-tauri/src/lib.rs (database init and command registration)
- specs/001-local-mr-review/tasks.md (marked T021-T024 complete)

### Learnings for Future Iterations
- Use `tauri::Manager` trait for `app.path()` and `app.manage()` methods
- Use `tauri::async_runtime::block_on` for async init in setup hook
- Use `State<'_, DbPool>` to access managed database pool in commands
- ON CONFLICT with RETURNING works for upsert in SQLite

---

## 2026-01-30 - T025, T026, T027
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created typed Tauri invoke wrapper (tauri.ts) with error handling
- Created GitLab service wrapper (gitlab.ts) with high-level operations
- Created storage service wrapper (storage.ts) for sync and settings
- Added index.ts for convenient re-exports

### Files Changed
- src/services/tauri.ts (new)
- src/services/gitlab.ts (new)
- src/services/storage.ts (new)
- src/services/index.ts (new)
- specs/001-local-mr-review/tasks.md (marked T025-T027 complete)

### Learnings for Future Iterations
- Import from @tauri-apps/api/core for invoke in Tauri 2
- Wrap invoke calls with proper error parsing for consistent error handling
- High-level service wrappers add business logic on top of raw Tauri calls

---
