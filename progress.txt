## Codebase Patterns
<!-- Consolidated learnings - check this FIRST before starting work -->

### Architecture
- Database layer is in `src-tauri/src/db/` with pool.rs for connection management and mod.rs for initialization/migrations
- SQL migrations are stored in `src-tauri/src/db/migrations/` as .sql files
- Migration tracking uses a `_migrations` table in SQLite
- Models are in `src-tauri/src/models/` with one file per entity and mod.rs for re-exports
- All models derive `Serialize`, `Deserialize`, and `FromRow` for Tauri IPC and SQLx compatibility

### Conventions
- Use `Path` instead of `PathBuf` for function parameters per Clippy recommendation
- SQL statements in migrations must be parsed carefully - semicolons inside parentheses (e.g., `strftime('%s', 'now')`) don't end statements
- All database tests use `tempfile` crate for isolated test databases

### Gotchas
- SQLite doesn't support executing multiple statements in a single query - must split and execute individually
- When splitting SQL by `;`, need to track parenthesis depth to avoid splitting inside DEFAULT expressions

---

## 2026-01-30 - T006, T007, T008
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created SQLite migration file with all 7 tables from data-model.md:
  - gitlab_instances, merge_requests, diffs, diff_files, comments, sync_queue, sync_log
- Implemented database initialization with migration runner in db/mod.rs
- Created SQLite connection pool with WAL mode in db/pool.rs
- Added tests for database initialization and idempotent migrations

### Files Changed
- src-tauri/src/db/migrations/0001_initial_schema.sql (new)
- src-tauri/src/db/mod.rs (updated)
- src-tauri/src/db/pool.rs (new)
- src-tauri/Cargo.toml (added tempfile dev dependency)
- specs/001-local-mr-review/tasks.md (marked T006-T008 complete)

### Learnings for Future Iterations
- SQLite migration parsing requires tracking parenthesis depth to handle DEFAULT expressions with semicolons
- Clippy prefers `&Path` over `&PathBuf` for function parameters
- Tests use tempfile::tempdir() for isolated database testing

---

## 2026-01-30 - T009, T010, T011, T012, T013, T014
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created all Rust model files matching data-model.md entities:
  - GitLabInstance with URL normalization
  - MergeRequest with state/approval enums and JSON field parsing
  - Diff and DiffFile with change type handling
  - Comment with inline/reply/general classification
  - SyncAction and SyncLog with status enums and retry logic
- All models derive Serialize (for Tauri IPC) and FromRow (for SQLx)
- Added comprehensive unit tests for all models

### Files Changed
- src-tauri/src/models/gitlab_instance.rs (new)
- src-tauri/src/models/merge_request.rs (new)
- src-tauri/src/models/diff.rs (new)
- src-tauri/src/models/comment.rs (new)
- src-tauri/src/models/sync_action.rs (new)
- src-tauri/src/models/mod.rs (updated with exports)
- specs/001-local-mr-review/tasks.md (marked T009-T014 complete)

### Learnings for Future Iterations
- Model enums use `From<&str>` trait for parsing database strings
- JSON fields (labels, reviewers) are stored as strings and parsed on demand
- SQLx FromRow requires field names to match column names exactly

---

## 2026-01-30 - T015
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created AppError enum with all error variants needed for Tauri IPC
- Added Serialize impl using tagged enum format for frontend consumption
- Added From impls for sqlx::Error, reqwest::Error, serde_json::Error, and DbError
- Added builder methods for each error variant with optional context

### Files Changed
- src-tauri/src/error.rs (new)
- src-tauri/src/lib.rs (added error module)
- specs/001-local-mr-review/tasks.md (marked T015 complete)

### Learnings for Future Iterations
- Use `#[serde(tag = "type", content = "details")]` for tagged enum serialization
- Use `#[serde(skip_serializing_if = "Option::is_none")]` to omit optional fields when None

---

## 2026-01-30 - T016, T017, T018
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created GitLabClient with reqwest for GitLab API v4
- Added PRIVATE-TOKEN header authentication
- Implemented pagination parsing from X-Page, X-Total-Pages headers
- Added get_all_pages helper for fetching complete paginated results
- Created API types: GitLabMergeRequest, GitLabDiffVersion, GitLabDiscussion, etc.
- Implemented MR listing, diff fetching, discussions, approvals, and comments

### Files Changed
- src-tauri/src/services/gitlab_client.rs (new)
- src-tauri/src/services/mod.rs (updated with gitlab_client export)
- specs/001-local-mr-review/tasks.md (marked T016-T018 complete)

### Learnings for Future Iterations
- GitLab pagination uses X-Page, X-Per-Page, X-Total, X-Total-Pages, X-Next-Page headers
- Can't define structs inside impl blocks in Rust - move them outside
- Use `#[derive(Serialize)]` with `#[serde(skip_serializing_if = "Option::is_none")]` for optional query params

---

## 2026-01-30 - T019, T020
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added `keyring` crate v3 for cross-platform credential storage
- Created CredentialService with store/get/delete/has_token operations
- Uses OS keychain (Keychain on macOS, Credential Manager on Windows, Secret Service on Linux)
- URL normalization for consistent account identifiers

### Files Changed
- src-tauri/Cargo.toml (added keyring dependency)
- src-tauri/src/services/credentials.rs (new)
- src-tauri/src/services/mod.rs (added credentials export)
- specs/001-local-mr-review/tasks.md (marked T019-T020 complete)

### Learnings for Future Iterations
- Use `keyring` crate (not a Tauri plugin) for OS keychain access
- keyring::Error::NoEntry for missing credentials - handle for idempotent operations
- SERVICE_NAME constant used across all credential operations for consistency

---

## 2026-01-30 - T021, T022, T023, T024
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created setup_gitlab_instance command: validates token, stores in keychain, inserts to DB
- Created get_gitlab_instances command: lists all instances with token status
- Created delete_gitlab_instance command: removes from keychain and DB (with cascade)
- Registered all auth commands in lib.rs with proper database setup
- Database pool is initialized in Tauri setup hook and managed via app state

### Files Changed
- src-tauri/src/commands/auth.rs (new)
- src-tauri/src/commands/mod.rs (updated with auth exports)
- src-tauri/src/lib.rs (database init and command registration)
- specs/001-local-mr-review/tasks.md (marked T021-T024 complete)

### Learnings for Future Iterations
- Use `tauri::Manager` trait for `app.path()` and `app.manage()` methods
- Use `tauri::async_runtime::block_on` for async init in setup hook
- Use `State<'_, DbPool>` to access managed database pool in commands
- ON CONFLICT with RETURNING works for upsert in SQLite

---

## 2026-01-30 - T025, T026, T027
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created typed Tauri invoke wrapper (tauri.ts) with error handling
- Created GitLab service wrapper (gitlab.ts) with high-level operations
- Created storage service wrapper (storage.ts) for sync and settings
- Added index.ts for convenient re-exports

### Files Changed
- src/services/tauri.ts (new)
- src/services/gitlab.ts (new)
- src/services/storage.ts (new)
- src/services/index.ts (new)
- specs/001-local-mr-review/tasks.md (marked T025-T027 complete)

### Learnings for Future Iterations
- Import from @tauri-apps/api/core for invoke in Tauri 2
- Wrap invoke calls with proper error parsing for consistent error handling
- High-level service wrappers add business logic on top of raw Tauri calls

---

## 2026-01-30 - T028, T029, T030
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created App.tsx with react-router-dom v7 routing
- Created Settings page with instance management UI
- Created InstanceSetup form component with validation
- Added placeholder pages for MRList and MRDetail

### Files Changed
- src/App.tsx (updated with routing)
- src/pages/Settings.tsx (new)
- src/pages/Settings.css (new)
- src/components/InstanceSetup/InstanceSetup.tsx (new)
- src/components/InstanceSetup/InstanceSetup.css (new)
- src/components/InstanceSetup/index.ts (new)
- src/services/gitlab.ts (added type re-exports)
- specs/001-local-mr-review/tasks.md (marked T028-T030 complete)

### Learnings for Future Iterations
- Use react-router-dom v7 with BrowserRouter, Routes, Route, Navigate
- Re-export types from service wrappers for component consumers
- Keep CSS separate for each component/page

---

## 2026-01-30 - T031, T032, T033, T034, T035
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created mr.rs with 4 MR reading commands:
  - get_merge_requests: List cached MRs with filtering (state, search)
  - get_merge_request_detail: MR with diff summary and pending actions count
  - get_diff_content: Unified diff content for MR or specific file
  - get_diff_file: Parsed diff hunks with line numbers for rendering
- Added unified diff parser for hunk extraction
- Registered all commands in lib.rs

### Files Changed
- src-tauri/src/commands/mr.rs (new)
- src-tauri/src/commands/mod.rs (added mr module)
- src-tauri/src/lib.rs (registered MR commands)
- specs/001-local-mr-review/tasks.md (marked T031-T035 complete)

### Learnings for Future Iterations
- When using `From<T>` impl with borrowed methods, call borrowing methods first before consuming fields
- Use `is_none_or()` instead of `map_or(true, ...)` per Clippy
- Unified diff parsing: hunk header format is `@@ -old_start,count +new_start,count @@`
- Syntax highlighting tokens placeholder in DiffLine - actual highlighting will come in T037-T039

---

## 2026-01-30 - T036, T037, T038, T039
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added tree-sitter language grammars to Cargo.toml for JS, TS, Python, Rust, Go
- Updated tree-sitter from 0.24 to 0.26 for grammar compatibility
- Created SyntaxHighlighter service with:
  - LazyLock-based configuration caching
  - Language detection from file extensions
  - tokenize() and tokenize_line() functions returning HighlightToken arrays
- Added comprehensive tests for all supported languages

### Files Changed
- src-tauri/Cargo.toml (added tree-sitter grammars, updated versions)
- src-tauri/Cargo.lock (dependency updates)
- src-tauri/src/services/highlighter.rs (new)
- src-tauri/src/services/mod.rs (added highlighter export)
- specs/001-local-mr-review/tasks.md (marked T036-T039 complete)

### Learnings for Future Iterations
- tree-sitter-highlight version must match language grammar ABI versions
- Language grammars have "version 15" which requires tree-sitter 0.26+
- JavaScript uses `HIGHLIGHT_QUERY` (singular), other languages use `HIGHLIGHTS_QUERY`
- HighlightConfiguration doesn't implement Clone - can't share refs easily
- Use match statement for extension -> config lookup instead of HashMap for non-Clone types

---

## 2026-01-30 - T040, T041, T042, T043, T044
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created MRList container component with filtering:
  - State filter (opened/merged/closed/all)
  - Scope filter (authored/reviewing/all)
  - Search text filter
- Created MRListItem component with:
  - State badge (open/merged/closed)
  - Relative time display
  - Approval status indicator
  - Labels display with overflow
- Created MRListPage with:
  - Instance selector dropdown
  - Keyboard navigation hints in footer
  - j/k navigation for list items
- Integrated MRListPage into App routing

### Files Changed
- src/components/MRList/MRList.tsx (new)
- src/components/MRList/MRList.css (new)
- src/components/MRList/MRListItem.tsx (new)
- src/components/MRList/MRListItem.css (new)
- src/components/MRList/index.ts (new)
- src/pages/MRListPage.tsx (new)
- src/pages/MRListPage.css (new)
- src/App.tsx (replaced placeholder with real page)
- specs/001-local-mr-review/tasks.md (marked T040-T044 complete)

### Learnings for Future Iterations
- Use CSS variables for theming (--bg-primary, --text-secondary, etc.)
- Keep kbd element styling consistent across keyboard hints
- Format relative time as "Xm ago", "Xh ago", "Xd ago" for readability
- Route paths should be consistent (use /mrs/:id not /mr/:id)

---

## 2026-01-30 - T045, T046, T047, T048, T049, T050, T051, T052
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created DiffViewer container with virtual scrolling:
  - Uses react-window v2 List component with rowComponent API
  - Conditionally enables virtual scrolling for large diffs (>2000px total)
  - Supports unified/split view toggle
- Created DiffLine with syntax highlighting:
  - Renders line number gutter with old/new line numbers
  - Applies syntax highlighting via hl-{token} CSS classes
  - Supports add/remove/context line types with color coding
- Created DiffHunk for grouping related lines
- Created FileNavigation sidebar:
  - Shows file list with change type indicators (A/M/D/R)
  - Displays additions/deletions per file
  - Supports keyboard focus
- Created syntax.css with comprehensive highlighting:
  - Light theme colors for all token types
  - Dark theme overrides via .dark-theme class
- Created MRDetailPage:
  - File sidebar + diff viewer layout
  - n/p keyboard shortcuts for file navigation
  - Esc to return to list

### Files Changed
- src/components/DiffViewer/DiffViewer.tsx (new)
- src/components/DiffViewer/DiffViewer.css (new)
- src/components/DiffViewer/DiffLine.tsx (new)
- src/components/DiffViewer/DiffLine.css (new)
- src/components/DiffViewer/DiffHunk.tsx (new)
- src/components/DiffViewer/DiffHunk.css (new)
- src/components/DiffViewer/FileNavigation.tsx (new)
- src/components/DiffViewer/FileNavigation.css (new)
- src/components/DiffViewer/index.ts (new)
- src/pages/MRDetailPage.tsx (new)
- src/pages/MRDetailPage.css (new)
- src/styles/syntax.css (new)
- src/App.tsx (updated to use real MRDetailPage)
- specs/001-local-mr-review/tasks.md (marked T045-T052 complete)

### Learnings for Future Iterations
- react-window v2 uses rowComponent/rowProps API instead of children render prop
- Use RowComponentProps<Props> type for virtual list row components
- Syntax highlighting classes use hl- prefix to avoid conflicts
- Dark theme handled via parent .dark-theme class selector

---

## 2026-01-30 - T053, T054, T055, T056
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created useKeyboardNav hook in src/hooks/:
  - j/k and arrow keys for list navigation
  - Enter to select focused item
  - Automatically clamps focus index to item count
- Created useFileNav hook for n/p file navigation
- Updated MRListPage to use useKeyboardNav:
  - Loads MR list separately for keyboard selection
  - Uses ref to access current MRs in callback
  - Enter now correctly opens focused MR

**Checkpoint Complete**: User Story 1 - Browse and Review MRs Offline-Fast

### Files Changed
- src/hooks/useKeyboardNav.ts (new)
- src/pages/MRListPage.tsx (updated to use hook)
- specs/001-local-mr-review/tasks.md (marked T053-T056 complete)

### Learnings for Future Iterations
- Use useRef to access current state in callbacks that are memoized
- Hook must handle case where itemCount changes
- Keep enabled flag to disable navigation when loading

---

## 2026-01-30 - T057, T058, T059, T060
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created sync_queue.rs service with:
  - enqueue_action() for adding actions to the queue
  - get_pending_actions() for fetching pending actions
  - get_retryable_actions() for fetching failed actions that can be retried
  - mark_syncing/mark_synced/mark_failed for status updates
  - retry_action/delete_action for managing actions
  - get_action_counts() for UI status display
  - Payload structs for Approval, Comment, Reply, Resolve actions
- Created sync_processor.rs service with:
  - process_action() for executing a single sync action
  - process_pending_actions() for batch processing
  - retry_failed_actions() for retrying failed actions
  - Support for all action types: approve, comment, reply, resolve, unresolve
  - Inline comment support with position (file_path, old_line, new_line, SHA info)
- Added add_inline_comment method to GitLabClient for inline diff comments

### Files Changed
- src-tauri/src/services/sync_queue.rs (new)
- src-tauri/src/services/sync_processor.rs (new)
- src-tauri/src/services/gitlab_client.rs (added add_inline_comment)
- src-tauri/src/services/mod.rs (added exports)
- specs/001-local-mr-review/tasks.md (marked T057-T060 complete)

### Learnings for Future Iterations
- Inline comments in GitLab require position object with base_sha, head_sha, start_sha
- Use db::initialize() in tests (run_migrations is private)
- Retry logic: increment retry_count on failure, mark as permanently failed after MAX_RETRIES

---

## 2026-01-30 - T061, T062, T063, T064, T065
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created comments.rs with 5 Tauri commands:
  - get_comments: List all comments for an MR with sync status
  - get_file_comments: Get inline comments for a specific file
  - add_comment: Add comment with optimistic insert and sync queue
  - reply_to_comment: Reply to discussion thread
  - resolve_discussion: Resolve/unresolve discussion with optimistic update
- Optimistic updates: comments inserted immediately with is_local=true
- Sync status tracking: comments show pending/synced/failed status
- Local IDs use negative timestamps to avoid GitLab ID conflicts
- Registered all 5 commands in lib.rs

### Files Changed
- src-tauri/src/commands/comments.rs (new)
- src-tauri/src/commands/mod.rs (added comments module)
- src-tauri/src/lib.rs (registered comment commands)
- src-tauri/src/services/sync_processor.rs (fixed test import)
- specs/001-local-mr-review/tasks.md (marked T061-T065 complete)

### Learnings for Future Iterations
- Use negative timestamps for local IDs (generate_local_id = -now())
- Inline comments need to inherit file_path/line info from parent comment for replies
- Sync status lookup uses local_reference_id to find related sync_queue entries

---

## 2026-01-30 - T066, T067, T068
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created approval.rs with 3 Tauri commands:
  - approve_mr: Approve MR with optimistic count increment
  - unapprove_mr: Remove approval with optimistic count decrement
  - get_approval_status: Get current approval status for MR
- Optimistic updates: approvals_count and approval_status updated immediately
- Sync queue integration: actions queued for GitLab sync
- Updated sync_processor to handle unapprove via payload action field
- Registered all 3 commands in lib.rs

### Files Changed
- src-tauri/src/commands/approval.rs (new)
- src-tauri/src/commands/mod.rs (added approval module)
- src-tauri/src/lib.rs (registered approval commands)
- src-tauri/src/services/sync_processor.rs (handle unapprove)
- specs/001-local-mr-review/tasks.md (marked T066-T068 complete)

### Learnings for Future Iterations
- Unapprove handled by checking payload.action field in sync_processor
- Approval status computed based on approvals_count >= approvals_required
- Use MAX() in SQL to prevent negative approvals_count on unapprove

---

## 2026-01-30 - T069, T070, T071, T075
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created CommentPanel container component:
  - Fetches and displays all comments for an MR
  - Groups comments by discussion ID for threading
  - Supports adding general comments and replies
  - Handles resolve/unresolve of discussions
- Created CommentThread component:
  - Displays discussion thread with root comment and replies
  - Shows sync status badges (pending/failed)
  - Visual distinction for local (pending) comments
  - Resolve/unresolve button
- Created CommentInput component:
  - Textarea with Cmd+Enter to submit
  - Escape to cancel
  - Disabled state while submitting
- Added sync status indicator to CommentThread (T075)
- Exported invoke function from tauri.ts for custom commands

### Files Changed
- src/components/CommentPanel/CommentPanel.tsx (new)
- src/components/CommentPanel/CommentPanel.css (new)
- src/components/CommentPanel/CommentThread.tsx (new)
- src/components/CommentPanel/CommentThread.css (new)
- src/components/CommentPanel/CommentInput.tsx (new)
- src/components/CommentPanel/CommentInput.css (new)
- src/components/CommentPanel/index.ts (new)
- src/services/tauri.ts (export invoke)
- specs/001-local-mr-review/tasks.md (marked T069-T071, T075 complete)

### Learnings for Future Iterations
- Group comments by discussionId for threading
- Local comments have is_local=true and need sync status from syncStatus field
- Use Cmd+Enter for submit, Escape for cancel (standard pattern)

---

## 2026-01-30 - T072, T073, T074
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created InlineComment component for displaying comments at line positions
- Integrated inline comments into DiffHunk:
  - Comments displayed below each line based on newLineNumber/oldLineNumber
  - Comment input form shown when adding new comment
- Added 'c' key to add comment at selected line in DiffViewer:
  - Tracks selected hunk and line
  - Shows inline comment input when 'c' pressed
  - Submits comment with file position info
- Updated DiffViewer props for comment support:
  - projectId, mrIid for API calls
  - currentUser for authoring
  - baseSha, headSha, startSha for inline comment positions
- Updated MRDetailPage to pass new DiffViewer props

### Files Changed
- src/components/CommentPanel/InlineComment.tsx (new)
- src/components/CommentPanel/InlineComment.css (new)
- src/components/CommentPanel/index.ts (added export)
- src/components/DiffViewer/DiffViewer.tsx (inline comment integration)
- src/components/DiffViewer/DiffHunk.tsx (render inline comments)
- src/pages/MRDetailPage.tsx (pass new DiffViewer props)
- specs/001-local-mr-review/tasks.md (marked T072-T074 complete)

### Learnings for Future Iterations
- Comments grouped by line number using newLineNumber ?? oldLineNumber
- Use useMemo for expensive comment grouping operations
- DiffHunk renders InlineComment below each line with comments

---

## 2026-01-30 - T076, T077, T078
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created ApprovalButton component with:
  - Optimistic state updates (UI updates immediately)
  - Rollback on error
  - Approve/unapprove toggle
  - Approval count display (X/Y required)
  - Changes requested badge
  - Error display
- Added ApprovalButton to MRDetailPage header
- Integrated with approve_mr/unapprove_mr backend commands

### Files Changed
- src/components/Approval/ApprovalButton.tsx (new)
- src/components/Approval/ApprovalButton.css (new)
- src/components/Approval/index.ts (new)
- src/pages/MRDetailPage.tsx (added ApprovalButton)
- specs/001-local-mr-review/tasks.md (marked T076-T078 complete)

### Learnings for Future Iterations
- Optimistic updates: update local state first, then call API
- Rollback pattern: restore previous state on error
- Use hasApproved to track current user's approval status

---

## 2026-01-30 - T079, T080, T081
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created useSyncStatus hook for tracking sync state:
  - Polls for action counts (pending/failed)
  - Provides triggerSync, retryAction, discardAction functions
  - Configurable poll interval
- Created PendingActionsIndicator component:
  - Shows pending/failed action counts
  - Compact mode for header placement
  - Expandable panel with Sync Now / Retry All buttons
  - Spinner animation while syncing
- Created get_action_counts command in sync.rs:
  - Wraps sync_queue::get_action_counts
  - Returns ActionCountsResponse { pending, failed }
- Registered command in lib.rs

**Checkpoint Complete**: User Story 2 - Approve and Comment with Optimistic Updates

### Files Changed
- src/hooks/useSyncStatus.ts (new)
- src/components/SyncStatus/PendingActionsIndicator.tsx (new)
- src/components/SyncStatus/PendingActionsIndicator.css (new)
- src/components/SyncStatus/index.ts (new)
- src-tauri/src/commands/sync.rs (new)
- src-tauri/src/commands/mod.rs (added sync module)
- src-tauri/src/lib.rs (registered get_action_counts)
- specs/001-local-mr-review/tasks.md (marked T079-T081 complete)

### Learnings for Future Iterations
- Use polling for sync status (Tauri events not yet implemented)
- Silently ignore errors for missing commands during development
- Compact mode useful for header/footer placement

---
