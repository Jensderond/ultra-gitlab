## Codebase Patterns
<!-- Consolidated learnings - check this FIRST before starting work -->

### Architecture
- Database layer is in `src-tauri/src/db/` with pool.rs for connection management and mod.rs for initialization/migrations
- SQL migrations are stored in `src-tauri/src/db/migrations/` as .sql files
- Migration tracking uses a `_migrations` table in SQLite
- Models are in `src-tauri/src/models/` with one file per entity and mod.rs for re-exports
- All models derive `Serialize`, `Deserialize`, and `FromRow` for Tauri IPC and SQLx compatibility

### Conventions
- Use `Path` instead of `PathBuf` for function parameters per Clippy recommendation
- SQL statements in migrations must be parsed carefully - semicolons inside parentheses (e.g., `strftime('%s', 'now')`) don't end statements
- All database tests use `tempfile` crate for isolated test databases

### Gotchas
- SQLite doesn't support executing multiple statements in a single query - must split and execute individually
- When splitting SQL by `;`, need to track parenthesis depth to avoid splitting inside DEFAULT expressions

---

## 2026-01-30 - T006, T007, T008
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created SQLite migration file with all 7 tables from data-model.md:
  - gitlab_instances, merge_requests, diffs, diff_files, comments, sync_queue, sync_log
- Implemented database initialization with migration runner in db/mod.rs
- Created SQLite connection pool with WAL mode in db/pool.rs
- Added tests for database initialization and idempotent migrations

### Files Changed
- src-tauri/src/db/migrations/0001_initial_schema.sql (new)
- src-tauri/src/db/mod.rs (updated)
- src-tauri/src/db/pool.rs (new)
- src-tauri/Cargo.toml (added tempfile dev dependency)
- specs/001-local-mr-review/tasks.md (marked T006-T008 complete)

### Learnings for Future Iterations
- SQLite migration parsing requires tracking parenthesis depth to handle DEFAULT expressions with semicolons
- Clippy prefers `&Path` over `&PathBuf` for function parameters
- Tests use tempfile::tempdir() for isolated database testing

---

## 2026-01-30 - T009, T010, T011, T012, T013, T014
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created all Rust model files matching data-model.md entities:
  - GitLabInstance with URL normalization
  - MergeRequest with state/approval enums and JSON field parsing
  - Diff and DiffFile with change type handling
  - Comment with inline/reply/general classification
  - SyncAction and SyncLog with status enums and retry logic
- All models derive Serialize (for Tauri IPC) and FromRow (for SQLx)
- Added comprehensive unit tests for all models

### Files Changed
- src-tauri/src/models/gitlab_instance.rs (new)
- src-tauri/src/models/merge_request.rs (new)
- src-tauri/src/models/diff.rs (new)
- src-tauri/src/models/comment.rs (new)
- src-tauri/src/models/sync_action.rs (new)
- src-tauri/src/models/mod.rs (updated with exports)
- specs/001-local-mr-review/tasks.md (marked T009-T014 complete)

### Learnings for Future Iterations
- Model enums use `From<&str>` trait for parsing database strings
- JSON fields (labels, reviewers) are stored as strings and parsed on demand
- SQLx FromRow requires field names to match column names exactly

---

## 2026-01-30 - T015
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created AppError enum with all error variants needed for Tauri IPC
- Added Serialize impl using tagged enum format for frontend consumption
- Added From impls for sqlx::Error, reqwest::Error, serde_json::Error, and DbError
- Added builder methods for each error variant with optional context

### Files Changed
- src-tauri/src/error.rs (new)
- src-tauri/src/lib.rs (added error module)
- specs/001-local-mr-review/tasks.md (marked T015 complete)

### Learnings for Future Iterations
- Use `#[serde(tag = "type", content = "details")]` for tagged enum serialization
- Use `#[serde(skip_serializing_if = "Option::is_none")]` to omit optional fields when None

---

## 2026-01-30 - T016, T017, T018
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created GitLabClient with reqwest for GitLab API v4
- Added PRIVATE-TOKEN header authentication
- Implemented pagination parsing from X-Page, X-Total-Pages headers
- Added get_all_pages helper for fetching complete paginated results
- Created API types: GitLabMergeRequest, GitLabDiffVersion, GitLabDiscussion, etc.
- Implemented MR listing, diff fetching, discussions, approvals, and comments

### Files Changed
- src-tauri/src/services/gitlab_client.rs (new)
- src-tauri/src/services/mod.rs (updated with gitlab_client export)
- specs/001-local-mr-review/tasks.md (marked T016-T018 complete)

### Learnings for Future Iterations
- GitLab pagination uses X-Page, X-Per-Page, X-Total, X-Total-Pages, X-Next-Page headers
- Can't define structs inside impl blocks in Rust - move them outside
- Use `#[derive(Serialize)]` with `#[serde(skip_serializing_if = "Option::is_none")]` for optional query params

---

## 2026-01-30 - T019, T020
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added `keyring` crate v3 for cross-platform credential storage
- Created CredentialService with store/get/delete/has_token operations
- Uses OS keychain (Keychain on macOS, Credential Manager on Windows, Secret Service on Linux)
- URL normalization for consistent account identifiers

### Files Changed
- src-tauri/Cargo.toml (added keyring dependency)
- src-tauri/src/services/credentials.rs (new)
- src-tauri/src/services/mod.rs (added credentials export)
- specs/001-local-mr-review/tasks.md (marked T019-T020 complete)

### Learnings for Future Iterations
- Use `keyring` crate (not a Tauri plugin) for OS keychain access
- keyring::Error::NoEntry for missing credentials - handle for idempotent operations
- SERVICE_NAME constant used across all credential operations for consistency

---

## 2026-01-30 - T021, T022, T023, T024
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created setup_gitlab_instance command: validates token, stores in keychain, inserts to DB
- Created get_gitlab_instances command: lists all instances with token status
- Created delete_gitlab_instance command: removes from keychain and DB (with cascade)
- Registered all auth commands in lib.rs with proper database setup
- Database pool is initialized in Tauri setup hook and managed via app state

### Files Changed
- src-tauri/src/commands/auth.rs (new)
- src-tauri/src/commands/mod.rs (updated with auth exports)
- src-tauri/src/lib.rs (database init and command registration)
- specs/001-local-mr-review/tasks.md (marked T021-T024 complete)

### Learnings for Future Iterations
- Use `tauri::Manager` trait for `app.path()` and `app.manage()` methods
- Use `tauri::async_runtime::block_on` for async init in setup hook
- Use `State<'_, DbPool>` to access managed database pool in commands
- ON CONFLICT with RETURNING works for upsert in SQLite

---

## 2026-01-30 - T025, T026, T027
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created typed Tauri invoke wrapper (tauri.ts) with error handling
- Created GitLab service wrapper (gitlab.ts) with high-level operations
- Created storage service wrapper (storage.ts) for sync and settings
- Added index.ts for convenient re-exports

### Files Changed
- src/services/tauri.ts (new)
- src/services/gitlab.ts (new)
- src/services/storage.ts (new)
- src/services/index.ts (new)
- specs/001-local-mr-review/tasks.md (marked T025-T027 complete)

### Learnings for Future Iterations
- Import from @tauri-apps/api/core for invoke in Tauri 2
- Wrap invoke calls with proper error parsing for consistent error handling
- High-level service wrappers add business logic on top of raw Tauri calls

---

## 2026-01-30 - T028, T029, T030
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created App.tsx with react-router-dom v7 routing
- Created Settings page with instance management UI
- Created InstanceSetup form component with validation
- Added placeholder pages for MRList and MRDetail

### Files Changed
- src/App.tsx (updated with routing)
- src/pages/Settings.tsx (new)
- src/pages/Settings.css (new)
- src/components/InstanceSetup/InstanceSetup.tsx (new)
- src/components/InstanceSetup/InstanceSetup.css (new)
- src/components/InstanceSetup/index.ts (new)
- src/services/gitlab.ts (added type re-exports)
- specs/001-local-mr-review/tasks.md (marked T028-T030 complete)

### Learnings for Future Iterations
- Use react-router-dom v7 with BrowserRouter, Routes, Route, Navigate
- Re-export types from service wrappers for component consumers
- Keep CSS separate for each component/page

---

## 2026-01-30 - T031, T032, T033, T034, T035
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created mr.rs with 4 MR reading commands:
  - get_merge_requests: List cached MRs with filtering (state, search)
  - get_merge_request_detail: MR with diff summary and pending actions count
  - get_diff_content: Unified diff content for MR or specific file
  - get_diff_file: Parsed diff hunks with line numbers for rendering
- Added unified diff parser for hunk extraction
- Registered all commands in lib.rs

### Files Changed
- src-tauri/src/commands/mr.rs (new)
- src-tauri/src/commands/mod.rs (added mr module)
- src-tauri/src/lib.rs (registered MR commands)
- specs/001-local-mr-review/tasks.md (marked T031-T035 complete)

### Learnings for Future Iterations
- When using `From<T>` impl with borrowed methods, call borrowing methods first before consuming fields
- Use `is_none_or()` instead of `map_or(true, ...)` per Clippy
- Unified diff parsing: hunk header format is `@@ -old_start,count +new_start,count @@`
- Syntax highlighting tokens placeholder in DiffLine - actual highlighting will come in T037-T039

---

## 2026-01-30 - T036, T037, T038, T039
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added tree-sitter language grammars to Cargo.toml for JS, TS, Python, Rust, Go
- Updated tree-sitter from 0.24 to 0.26 for grammar compatibility
- Created SyntaxHighlighter service with:
  - LazyLock-based configuration caching
  - Language detection from file extensions
  - tokenize() and tokenize_line() functions returning HighlightToken arrays
- Added comprehensive tests for all supported languages

### Files Changed
- src-tauri/Cargo.toml (added tree-sitter grammars, updated versions)
- src-tauri/Cargo.lock (dependency updates)
- src-tauri/src/services/highlighter.rs (new)
- src-tauri/src/services/mod.rs (added highlighter export)
- specs/001-local-mr-review/tasks.md (marked T036-T039 complete)

### Learnings for Future Iterations
- tree-sitter-highlight version must match language grammar ABI versions
- Language grammars have "version 15" which requires tree-sitter 0.26+
- JavaScript uses `HIGHLIGHT_QUERY` (singular), other languages use `HIGHLIGHTS_QUERY`
- HighlightConfiguration doesn't implement Clone - can't share refs easily
- Use match statement for extension -> config lookup instead of HashMap for non-Clone types

---

## 2026-01-30 - T040, T041, T042, T043, T044
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created MRList container component with filtering:
  - State filter (opened/merged/closed/all)
  - Scope filter (authored/reviewing/all)
  - Search text filter
- Created MRListItem component with:
  - State badge (open/merged/closed)
  - Relative time display
  - Approval status indicator
  - Labels display with overflow
- Created MRListPage with:
  - Instance selector dropdown
  - Keyboard navigation hints in footer
  - j/k navigation for list items
- Integrated MRListPage into App routing

### Files Changed
- src/components/MRList/MRList.tsx (new)
- src/components/MRList/MRList.css (new)
- src/components/MRList/MRListItem.tsx (new)
- src/components/MRList/MRListItem.css (new)
- src/components/MRList/index.ts (new)
- src/pages/MRListPage.tsx (new)
- src/pages/MRListPage.css (new)
- src/App.tsx (replaced placeholder with real page)
- specs/001-local-mr-review/tasks.md (marked T040-T044 complete)

### Learnings for Future Iterations
- Use CSS variables for theming (--bg-primary, --text-secondary, etc.)
- Keep kbd element styling consistent across keyboard hints
- Format relative time as "Xm ago", "Xh ago", "Xd ago" for readability
- Route paths should be consistent (use /mrs/:id not /mr/:id)

---

## 2026-01-30 - T045, T046, T047, T048, T049, T050, T051, T052
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created DiffViewer container with virtual scrolling:
  - Uses react-window v2 List component with rowComponent API
  - Conditionally enables virtual scrolling for large diffs (>2000px total)
  - Supports unified/split view toggle
- Created DiffLine with syntax highlighting:
  - Renders line number gutter with old/new line numbers
  - Applies syntax highlighting via hl-{token} CSS classes
  - Supports add/remove/context line types with color coding
- Created DiffHunk for grouping related lines
- Created FileNavigation sidebar:
  - Shows file list with change type indicators (A/M/D/R)
  - Displays additions/deletions per file
  - Supports keyboard focus
- Created syntax.css with comprehensive highlighting:
  - Light theme colors for all token types
  - Dark theme overrides via .dark-theme class
- Created MRDetailPage:
  - File sidebar + diff viewer layout
  - n/p keyboard shortcuts for file navigation
  - Esc to return to list

### Files Changed
- src/components/DiffViewer/DiffViewer.tsx (new)
- src/components/DiffViewer/DiffViewer.css (new)
- src/components/DiffViewer/DiffLine.tsx (new)
- src/components/DiffViewer/DiffLine.css (new)
- src/components/DiffViewer/DiffHunk.tsx (new)
- src/components/DiffViewer/DiffHunk.css (new)
- src/components/DiffViewer/FileNavigation.tsx (new)
- src/components/DiffViewer/FileNavigation.css (new)
- src/components/DiffViewer/index.ts (new)
- src/pages/MRDetailPage.tsx (new)
- src/pages/MRDetailPage.css (new)
- src/styles/syntax.css (new)
- src/App.tsx (updated to use real MRDetailPage)
- specs/001-local-mr-review/tasks.md (marked T045-T052 complete)

### Learnings for Future Iterations
- react-window v2 uses rowComponent/rowProps API instead of children render prop
- Use RowComponentProps<Props> type for virtual list row components
- Syntax highlighting classes use hl- prefix to avoid conflicts
- Dark theme handled via parent .dark-theme class selector

---

## 2026-01-30 - T053, T054, T055, T056
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created useKeyboardNav hook in src/hooks/:
  - j/k and arrow keys for list navigation
  - Enter to select focused item
  - Automatically clamps focus index to item count
- Created useFileNav hook for n/p file navigation
- Updated MRListPage to use useKeyboardNav:
  - Loads MR list separately for keyboard selection
  - Uses ref to access current MRs in callback
  - Enter now correctly opens focused MR

**Checkpoint Complete**: User Story 1 - Browse and Review MRs Offline-Fast

### Files Changed
- src/hooks/useKeyboardNav.ts (new)
- src/pages/MRListPage.tsx (updated to use hook)
- specs/001-local-mr-review/tasks.md (marked T053-T056 complete)

### Learnings for Future Iterations
- Use useRef to access current state in callbacks that are memoized
- Hook must handle case where itemCount changes
- Keep enabled flag to disable navigation when loading

---

## 2026-01-30 - T057, T058, T059, T060
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created sync_queue.rs service with:
  - enqueue_action() for adding actions to the queue
  - get_pending_actions() for fetching pending actions
  - get_retryable_actions() for fetching failed actions that can be retried
  - mark_syncing/mark_synced/mark_failed for status updates
  - retry_action/delete_action for managing actions
  - get_action_counts() for UI status display
  - Payload structs for Approval, Comment, Reply, Resolve actions
- Created sync_processor.rs service with:
  - process_action() for executing a single sync action
  - process_pending_actions() for batch processing
  - retry_failed_actions() for retrying failed actions
  - Support for all action types: approve, comment, reply, resolve, unresolve
  - Inline comment support with position (file_path, old_line, new_line, SHA info)
- Added add_inline_comment method to GitLabClient for inline diff comments

### Files Changed
- src-tauri/src/services/sync_queue.rs (new)
- src-tauri/src/services/sync_processor.rs (new)
- src-tauri/src/services/gitlab_client.rs (added add_inline_comment)
- src-tauri/src/services/mod.rs (added exports)
- specs/001-local-mr-review/tasks.md (marked T057-T060 complete)

### Learnings for Future Iterations
- Inline comments in GitLab require position object with base_sha, head_sha, start_sha
- Use db::initialize() in tests (run_migrations is private)
- Retry logic: increment retry_count on failure, mark as permanently failed after MAX_RETRIES

---

## 2026-01-30 - T061, T062, T063, T064, T065
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created comments.rs with 5 Tauri commands:
  - get_comments: List all comments for an MR with sync status
  - get_file_comments: Get inline comments for a specific file
  - add_comment: Add comment with optimistic insert and sync queue
  - reply_to_comment: Reply to discussion thread
  - resolve_discussion: Resolve/unresolve discussion with optimistic update
- Optimistic updates: comments inserted immediately with is_local=true
- Sync status tracking: comments show pending/synced/failed status
- Local IDs use negative timestamps to avoid GitLab ID conflicts
- Registered all 5 commands in lib.rs

### Files Changed
- src-tauri/src/commands/comments.rs (new)
- src-tauri/src/commands/mod.rs (added comments module)
- src-tauri/src/lib.rs (registered comment commands)
- src-tauri/src/services/sync_processor.rs (fixed test import)
- specs/001-local-mr-review/tasks.md (marked T061-T065 complete)

### Learnings for Future Iterations
- Use negative timestamps for local IDs (generate_local_id = -now())
- Inline comments need to inherit file_path/line info from parent comment for replies
- Sync status lookup uses local_reference_id to find related sync_queue entries

---

## 2026-01-30 - T066, T067, T068
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created approval.rs with 3 Tauri commands:
  - approve_mr: Approve MR with optimistic count increment
  - unapprove_mr: Remove approval with optimistic count decrement
  - get_approval_status: Get current approval status for MR
- Optimistic updates: approvals_count and approval_status updated immediately
- Sync queue integration: actions queued for GitLab sync
- Updated sync_processor to handle unapprove via payload action field
- Registered all 3 commands in lib.rs

### Files Changed
- src-tauri/src/commands/approval.rs (new)
- src-tauri/src/commands/mod.rs (added approval module)
- src-tauri/src/lib.rs (registered approval commands)
- src-tauri/src/services/sync_processor.rs (handle unapprove)
- specs/001-local-mr-review/tasks.md (marked T066-T068 complete)

### Learnings for Future Iterations
- Unapprove handled by checking payload.action field in sync_processor
- Approval status computed based on approvals_count >= approvals_required
- Use MAX() in SQL to prevent negative approvals_count on unapprove

---

## 2026-01-30 - T069, T070, T071, T075
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created CommentPanel container component:
  - Fetches and displays all comments for an MR
  - Groups comments by discussion ID for threading
  - Supports adding general comments and replies
  - Handles resolve/unresolve of discussions
- Created CommentThread component:
  - Displays discussion thread with root comment and replies
  - Shows sync status badges (pending/failed)
  - Visual distinction for local (pending) comments
  - Resolve/unresolve button
- Created CommentInput component:
  - Textarea with Cmd+Enter to submit
  - Escape to cancel
  - Disabled state while submitting
- Added sync status indicator to CommentThread (T075)
- Exported invoke function from tauri.ts for custom commands

### Files Changed
- src/components/CommentPanel/CommentPanel.tsx (new)
- src/components/CommentPanel/CommentPanel.css (new)
- src/components/CommentPanel/CommentThread.tsx (new)
- src/components/CommentPanel/CommentThread.css (new)
- src/components/CommentPanel/CommentInput.tsx (new)
- src/components/CommentPanel/CommentInput.css (new)
- src/components/CommentPanel/index.ts (new)
- src/services/tauri.ts (export invoke)
- specs/001-local-mr-review/tasks.md (marked T069-T071, T075 complete)

### Learnings for Future Iterations
- Group comments by discussionId for threading
- Local comments have is_local=true and need sync status from syncStatus field
- Use Cmd+Enter for submit, Escape for cancel (standard pattern)

---

## 2026-01-30 - T072, T073, T074
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created InlineComment component for displaying comments at line positions
- Integrated inline comments into DiffHunk:
  - Comments displayed below each line based on newLineNumber/oldLineNumber
  - Comment input form shown when adding new comment
- Added 'c' key to add comment at selected line in DiffViewer:
  - Tracks selected hunk and line
  - Shows inline comment input when 'c' pressed
  - Submits comment with file position info
- Updated DiffViewer props for comment support:
  - projectId, mrIid for API calls
  - currentUser for authoring
  - baseSha, headSha, startSha for inline comment positions
- Updated MRDetailPage to pass new DiffViewer props

### Files Changed
- src/components/CommentPanel/InlineComment.tsx (new)
- src/components/CommentPanel/InlineComment.css (new)
- src/components/CommentPanel/index.ts (added export)
- src/components/DiffViewer/DiffViewer.tsx (inline comment integration)
- src/components/DiffViewer/DiffHunk.tsx (render inline comments)
- src/pages/MRDetailPage.tsx (pass new DiffViewer props)
- specs/001-local-mr-review/tasks.md (marked T072-T074 complete)

### Learnings for Future Iterations
- Comments grouped by line number using newLineNumber ?? oldLineNumber
- Use useMemo for expensive comment grouping operations
- DiffHunk renders InlineComment below each line with comments

---

## 2026-01-30 - T076, T077, T078
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created ApprovalButton component with:
  - Optimistic state updates (UI updates immediately)
  - Rollback on error
  - Approve/unapprove toggle
  - Approval count display (X/Y required)
  - Changes requested badge
  - Error display
- Added ApprovalButton to MRDetailPage header
- Integrated with approve_mr/unapprove_mr backend commands

### Files Changed
- src/components/Approval/ApprovalButton.tsx (new)
- src/components/Approval/ApprovalButton.css (new)
- src/components/Approval/index.ts (new)
- src/pages/MRDetailPage.tsx (added ApprovalButton)
- specs/001-local-mr-review/tasks.md (marked T076-T078 complete)

### Learnings for Future Iterations
- Optimistic updates: update local state first, then call API
- Rollback pattern: restore previous state on error
- Use hasApproved to track current user's approval status

---

## 2026-01-30 - T079, T080, T081
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created useSyncStatus hook for tracking sync state:
  - Polls for action counts (pending/failed)
  - Provides triggerSync, retryAction, discardAction functions
  - Configurable poll interval
- Created PendingActionsIndicator component:
  - Shows pending/failed action counts
  - Compact mode for header placement
  - Expandable panel with Sync Now / Retry All buttons
  - Spinner animation while syncing
- Created get_action_counts command in sync.rs:
  - Wraps sync_queue::get_action_counts
  - Returns ActionCountsResponse { pending, failed }
- Registered command in lib.rs

**Checkpoint Complete**: User Story 2 - Approve and Comment with Optimistic Updates

### Files Changed
- src/hooks/useSyncStatus.ts (new)
- src/components/SyncStatus/PendingActionsIndicator.tsx (new)
- src/components/SyncStatus/PendingActionsIndicator.css (new)
- src/components/SyncStatus/index.ts (new)
- src-tauri/src/commands/sync.rs (new)
- src-tauri/src/commands/mod.rs (added sync module)
- src-tauri/src/lib.rs (registered get_action_counts)
- specs/001-local-mr-review/tasks.md (marked T079-T081 complete)

### Learnings for Future Iterations
- Use polling for sync status (Tauri events not yet implemented)
- Silently ignore errors for missing commands during development
- Compact mode useful for header/footer placement

---

## 2026-01-30 - T082-T104
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created sync_engine.rs with comprehensive background sync:
  - Background sync scheduler with configurable interval
  - MR fetch logic with author/reviewer scope filters
  - Diff and comments fetch during sync
  - Sync queue processing (push pending actions to GitLab)
  - Sync logging to sync_log table
  - MR purge on merge/close per FR-005a
- Created sync_events.rs with Tauri event types:
  - sync-progress events for sync operation updates
  - mr-updated events when MRs change
  - action-synced events when actions complete
- Extended sync.rs commands:
  - trigger_sync command with progress events
  - get_sync_status command with log entries
  - retry_failed_actions command with action-synced events
  - discard_failed_action command
  - get_sync_config/update_sync_config commands
- Created settings.rs commands:
  - get_settings/update_settings for app settings
  - get_sync_settings/update_sync_settings convenience commands
  - Settings persisted via tauri-plugin-store
- Created SyncStatusBar component:
  - Last sync time display
  - Sync-in-progress indicator
  - New MRs notification badge
  - Manual sync trigger (Cmd+R)
  - Expandable log panel toggle
- Created SyncLogPanel component:
  - Recent sync operations display
  - Operation status and duration
  - Expandable detail view
- Updated useSyncStatus hook:
  - Tauri event subscriptions for reactive updates
  - Full sync status including logs
  - New MRs count tracking
- Updated Settings page with sync interval configuration:
  - Sync interval dropdown (1-30 minutes)
  - Sync scope checkboxes (authored/reviewing)
  - Settings auto-save on change

**Checkpoint Complete**: User Story 3 - Background Sync of New MRs

### Files Changed
- src-tauri/src/services/sync_engine.rs (new)
- src-tauri/src/services/sync_events.rs (new)
- src-tauri/src/services/mod.rs (added exports)
- src-tauri/src/commands/sync.rs (extended with new commands)
- src-tauri/src/commands/settings.rs (new)
- src-tauri/src/commands/mod.rs (added settings module)
- src-tauri/src/lib.rs (registered new commands)
- src/hooks/useSyncStatus.ts (updated with Tauri events)
- src/components/SyncStatus/SyncStatusBar.tsx (new)
- src/components/SyncStatus/SyncStatusBar.css (new)
- src/components/SyncStatus/SyncLogPanel.tsx (new)
- src/components/SyncStatus/SyncLogPanel.css (new)
- src/components/SyncStatus/index.ts (updated exports)
- src/pages/Settings.tsx (added sync settings UI)
- src/pages/Settings.css (added sync settings styles)
- specs/001-local-mr-review/tasks.md (marked T082-T104 complete)

### Learnings for Future Iterations
- SyncEngine can run as one-shot or background task via start_background()
- Tauri events emitted from commands for real-time UI updates
- Settings persisted via tauri-plugin-store with "settings.json"
- ISO timestamps parsed with chrono::DateTime::parse_from_rfc3339()
- OnceLock + RwLock pattern for in-memory settings cache

---

## 2026-01-30 - T105, T106, T107, T108, T109
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created CommandPalette container with fuzzy search:
  - Overlay with animated slide-in
  - Search input with real-time filtering
  - Grouped commands by category
  - Keyboard navigation (up/down arrows, Enter, Escape)
  - Scroll into view for selected item
- Created CommandItem component:
  - Displays label, description, and keyboard shortcut
  - Shortcut key formatting (Cmd → ⌘, etc.)
- Created command registry:
  - All available actions defined with categories
  - CommandId enum for programmatic access
  - createCommands() helper for binding actions
- Added global keyboard shortcuts in App.tsx:
  - Cmd+P to open command palette
  - Cmd+, to open settings
  - Cmd+R to trigger sync

### Files Changed
- src/components/CommandPalette/CommandPalette.tsx (new)
- src/components/CommandPalette/CommandPalette.css (new)
- src/components/CommandPalette/CommandItem.tsx (new)
- src/components/CommandPalette/CommandItem.css (new)
- src/components/CommandPalette/index.ts (new)
- src/commands/registry.ts (new)
- src/App.tsx (added command palette, global shortcuts)
- specs/001-local-mr-review/tasks.md (marked T105-T109 complete)

### Learnings for Future Iterations
- Command palette opens in AppContent (not App) to have access to router hooks
- Use useLocation() to determine current context for available commands
- Fuzzy search scores: exact match (100), starts with (90), contains (70), fuzzy char match (0-60)
- manualSync() is exported from storage.ts, not triggerSync

---

## 2026-01-30 - T110, T111, T112
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created KeyboardHelp overlay component:
  - Shows all shortcuts organized by category
  - Escape or '?' to close
  - Click outside to close
- Created shortcuts config in src/config/shortcuts.ts:
  - ShortcutDefinition type with id, description, key, category, context
  - All default shortcuts defined
  - Helper functions: getShortcutsForContext, getShortcutsByCategory, formatKey
- Added '?' global shortcut in App.tsx:
  - Opens keyboard help overlay
  - Added ShowKeyboardHelp to command palette actions

### Files Changed
- src/components/KeyboardHelp/KeyboardHelp.tsx (new)
- src/components/KeyboardHelp/KeyboardHelp.css (new)
- src/components/KeyboardHelp/index.ts (new)
- src/config/shortcuts.ts (new)
- src/App.tsx (added keyboard help integration)
- specs/001-local-mr-review/tasks.md (marked T110-T112 complete)

### Learnings for Future Iterations
- Category ordering matters for display - use explicit array order
- formatKey() converts modifier keys to symbols (Cmd → ⌘)
- Escape and '?' both close the help overlay for convenience

---

## 2026-01-30 - T113, T114, T115
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created useCustomShortcuts hook:
  - Loads/saves custom bindings from settings
  - Merges with default shortcuts
  - Provides setBinding, resetBinding, resetAllBindings functions
  - isKeyInUse conflict detection
- Created shortcut editor UI in Settings:
  - Groups shortcuts by category
  - Click-to-edit with key capture
  - Shows custom bindings with highlight
  - Individual reset and reset-all buttons
- Persistence via saveSettings({ keyboardShortcuts })

### Files Changed
- src/hooks/useCustomShortcuts.ts (new)
- src/pages/Settings.tsx (added ShortcutEditor component)
- src/pages/Settings.css (added shortcut editor styles)
- specs/001-local-mr-review/tasks.md (marked T113-T115 complete)

### Learnings for Future Iterations
- Key capture via onKeyDown with preventDefault
- Build key string from metaKey/ctrlKey/altKey/shiftKey + key
- Conflict detection before saving with isKeyInUse helper
- Optimistic updates with rollback on error

---

## 2026-01-30 - T116, T117, T118, T119
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added ] / [ change navigation in DiffViewer:
  - Finds all add/remove lines (changes)
  - Navigates between them with wrap-around
  - Also added 'd' to toggle unified/split view
- Added 'a' shortcut for approve in MRDetailPage:
  - ApprovalButton now uses forwardRef + useImperativeHandle
  - Exposes toggle() method via ApprovalButtonRef
  - MRDetailPage uses ref to call toggle on 'a' key
- Enhanced 'c' shortcut (already existed from T074):
  - Now properly ignores when typing in inputs
- Escape handling already exists in components:
  - CommandPalette, KeyboardHelp close on Escape
  - DiffViewer cancels comment on Escape
  - MRDetailPage goes back on Escape

**Checkpoint Complete**: User Story 4 - Keyboard-Driven Navigation

### Files Changed
- src/components/DiffViewer/DiffViewer.tsx (added ]/[/d shortcuts)
- src/components/Approval/ApprovalButton.tsx (forwardRef + toggle)
- src/components/Approval/index.ts (export ApprovalButtonRef)
- src/pages/MRDetailPage.tsx (added 'a' shortcut, updated hints)
- specs/001-local-mr-review/tasks.md (marked T116-T119 complete)

### Learnings for Future Iterations
- forwardRef + useImperativeHandle for exposing methods to parent
- Change positions can be memoized from diffContent hunks
- Wrap-around navigation: if out of bounds, wrap to other end

---

## 2026-01-30 - T120
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added cache size warning to SyncStatus:
  - cache_size_bytes: Current database size in bytes
  - cache_size_warning: True when >= 400MB (approaching 500MB limit)
- Calculate cache size using SQLite's page_count * page_size
- Warning logged during sync when threshold exceeded
- Updated frontend TypeScript types

### Files Changed
- src-tauri/src/services/sync_engine.rs (added cache size check)
- src/types/index.ts (added cacheSizeBytes, cacheSizeWarning)
- specs/001-local-mr-review/tasks.md (marked T120 complete)

### Learnings for Future Iterations
- SQLite database size: page_count * page_size via pragma functions
- Use constants for thresholds (CACHE_SIZE_WARNING_BYTES, CACHE_SIZE_LIMIT_BYTES)

---

## 2026-01-30 - T121
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added progressive diff loading for large diffs (>10k lines):
  - New `get_diff_file_metadata` command returns hunk count, line count, and isLarge flag
  - New `get_diff_hunks` command returns paginated hunks for on-demand loading
  - LARGE_DIFF_THRESHOLD constant set to 10,000 lines
- Updated DiffViewer.tsx for progressive loading:
  - Checks metadata first to detect large diffs
  - For large diffs, initializes with null placeholders for all hunks
  - Loads hunks progressively as user scrolls (HUNK_BATCH_SIZE=20, HUNK_PREFETCH_BUFFER=10)
  - Shows loading placeholder with animation for unloaded hunks
  - Displays "Large diff (X lines)" indicator in header
- Added CSS styles for loading placeholders and large diff indicator

### Files Changed
- src-tauri/src/commands/mr.rs (added get_diff_file_metadata, get_diff_hunks)
- src-tauri/src/commands/mod.rs (added exports)
- src-tauri/src/lib.rs (registered new commands)
- src/types/index.ts (added DiffFileMetadata, DiffHunksResponse)
- src/services/tauri.ts (added getDiffFileMetadata, getDiffHunks)
- src/services/gitlab.ts (added getFileDiffMetadata, getFileDiffHunks)
- src/components/DiffViewer/DiffViewer.tsx (progressive loading implementation)
- src/components/DiffViewer/DiffViewer.css (loading placeholder styles)
- specs/001-local-mr-review/tasks.md (marked T121 complete)

### Learnings for Future Iterations
- react-window v2 uses standard HTML onScroll, not custom scrollOffset callback
- Use Set<number> to track loading and loaded hunk indices for efficient lookup
- Estimate visible hunks from scroll position when hunks have variable heights
- Initialize with null placeholders for progressive loading arrays

---

## 2026-01-30 - T122
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added conflict detection for stale MR actions in sync_processor.rs:
  - Detects 404 Not Found (MR deleted)
  - Detects 405 Method Not Allowed (MR merged/closed)
  - Detects 403 Forbidden with "merged"/"closed" keywords
  - Detects 400 Bad Request for invalid comment positions (line deleted)
- Added new `discarded` status to SyncStatus enum in sync_action.rs
- Added `mark_discarded` function in sync_queue.rs for discarding stale actions
- Created migration 0002_add_discarded_status.sql to update CHECK constraint
- Updated migration runner to support multiple migrations dynamically
- Updated ProcessResult to include `discarded` field for tracking
- Added DiscardReason enum with human-readable messages
- Updated frontend types to include 'discarded' in ActionStatus and SyncStatus

### Files Changed
- src-tauri/src/models/sync_action.rs (added Discarded status)
- src-tauri/src/services/sync_queue.rs (added mark_discarded)
- src-tauri/src/services/sync_processor.rs (conflict detection logic)
- src-tauri/src/db/migrations/0002_add_discarded_status.sql (new)
- src-tauri/src/db/mod.rs (generalized migration runner)
- src-tauri/Cargo.toml (added log crate)
- src/types/index.ts (added discarded to ActionStatus and SyncStatus)
- specs/001-local-mr-review/tasks.md (marked T122 complete)

### Learnings for Future Iterations
- SQLite CHECK constraints require table recreation to modify - use new migration
- Migration runner should be dynamic with a list of (name, sql) tuples
- GitLab returns 405 for actions on merged/closed MRs (not 403)
- Use `log::info!` for informational logging - add `log` crate to Cargo.toml
- Discard stale actions immediately instead of retrying forever

---

## 2026-01-30 - T123
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Added AuthenticationExpired error variant with optional instance_id and instance_url
- Updated GitLab client to return AuthenticationExpired for 401 Unauthorized responses
- Added auth-expired Tauri event with AuthExpiredPayload struct
- Updated sync commands to detect auth errors and emit auth-expired events
- Enhanced sync_engine to propagate auth errors with instance info
- Created ReAuthPrompt modal component:
  - Shield icon with warning colors
  - Clear messaging about token expiry
  - Instance URL display
  - "Go to Settings" primary action
  - Dismiss option
  - Hint text about generating new token
  - Dark theme support
- Added auth-expired event listener in App.tsx
- Updated frontend types with AuthExpiredPayload interface

### Files Changed
- src-tauri/src/error.rs (added AuthenticationExpired variant and helpers)
- src-tauri/src/services/gitlab_client.rs (detect 401 and return auth expired)
- src-tauri/src/services/sync_events.rs (added AUTH_EXPIRED_EVENT and payload)
- src-tauri/src/services/sync_engine.rs (propagate auth errors with instance info)
- src-tauri/src/commands/sync.rs (emit auth-expired events on failure)
- src/types/index.ts (added AuthExpiredPayload)
- src/App.tsx (listen for auth-expired, show ReAuthPrompt)
- src/components/ReAuthPrompt/ReAuthPrompt.tsx (new)
- src/components/ReAuthPrompt/ReAuthPrompt.css (new)
- src/components/ReAuthPrompt/index.ts (new)
- specs/001-local-mr-review/tasks.md (marked T123 complete)

### Learnings for Future Iterations
- thiserror's #[error(...)] macro can't use Option<String> directly in format - simplify message
- Clone URL before moving into struct to use in error handling later
- Use dedicated event types for specific error conditions (auth expiry vs generic errors)
- Modal overlays need both click-outside-to-dismiss and explicit dismiss button

---

## 2026-01-30 - T124, T125, T127
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- T124: Added performance logging to MRList with 200ms target indicator
- T125: Added performance logging to DiffViewer with 100ms target indicator
- T127: Added tree-sitter grammars for 6 additional languages:
  - Java (.java)
  - C (.c, .h)
  - C++ (.cpp, .cc, .cxx, .hpp, .hxx)
  - Ruby (.rb)
  - PHP (.php)
  - Swift (.swift)
  - Note: Kotlin disabled due to tree-sitter-kotlin using incompatible API

### Files Changed
- src/components/MRList/MRList.tsx (added performance logging)
- src/components/DiffViewer/DiffViewer.tsx (added performance logging)
- src-tauri/Cargo.toml (added language grammar dependencies)
- src-tauri/src/services/highlighter.rs (added 7 new language configs + tests)
- specs/001-local-mr-review/tasks.md (marked T124, T125, T127 complete)

### Learnings for Future Iterations
- tree-sitter-c and tree-sitter-cpp use HIGHLIGHT_QUERY (singular), not HIGHLIGHTS_QUERY
- tree-sitter-kotlin 0.3.x uses tree-sitter 0.20 API, incompatible with 0.26
- Some languages use language() function vs LANGUAGE constant
- Use performance.now() for accurate timing measurements
- Log with pass/fail indicator for easy scanning in console

---

## 2026-01-30 - T126
**Workflow**: Speckit
**Feature**: 001-local-mr-review

### Implemented
- Created diagnostics module for memory and performance verification (SC-008)
- Added `sysinfo` crate for cross-platform process memory measurement
- Created Tauri commands:
  - get_memory_stats: Process and system memory usage
  - get_cache_stats: MR count, diff files, comments, DB size
  - get_diagnostics_report: Combined memory and cache stats
  - generate_test_data: Creates 100 MRs with realistic diffs/comments
  - clear_test_data: Removes test data (IDs >= 1,000,000)
- Created integration test (memory_verification.rs):
  - Populates 100 MRs with 1000 diff files and 500 comments
  - Measures memory usage: ~13.27 MB (well under 500MB target)
  - ✅ SC-008 PASS: Memory stays under 500MB limit
- Added TypeScript types and service functions for diagnostics

### Files Changed
- src-tauri/Cargo.toml (added sysinfo dependency)
- src-tauri/Cargo.lock (updated)
- src-tauri/src/commands/diagnostics.rs (new)
- src-tauri/src/commands/mod.rs (added diagnostics module)
- src-tauri/src/lib.rs (registered diagnostics commands)
- src-tauri/tests/memory_verification.rs (new)
- src/types/index.ts (added diagnostics types)
- src/services/tauri.ts (added diagnostics functions)
- specs/001-local-mr-review/tasks.md (marked T126 complete)

### Learnings for Future Iterations
- Use `sysinfo` crate v0.32+ for process memory measurement
- Tauri State<T> uses pool.inner() not pool.get().await
- Integration tests go in src-tauri/tests/ directory
- Test data should use high IDs (>= 1,000,000) to avoid conflicts
- SQLite database size: page_count * page_size via pragma

---
