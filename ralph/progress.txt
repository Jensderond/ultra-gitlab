## Codebase Patterns
- MonacoDiffViewer is at src/components/Monaco/MonacoDiffViewer.tsx — forwardRef component with imperative ref API
- Monaco options configured in the component: folding: true, showFoldingControls: "always", splitView with viewMode prop
- Key Monaco APIs: editor.getLineChanges(), getOriginalEditor(), getModifiedEditor(), setHiddenAreas()
- ViewZone API for injecting custom DOM between editor lines
- Kanagawa theme defined in src/components/Monaco/kanagawaTheme.ts with diff-specific colors
- Monaco CSS in src/components/Monaco/monaco.css (comment decorations, glyph styles)
- Language detection in src/components/Monaco/languageDetection.ts
- Component used in MRDetailPage.tsx with props: originalContent, modifiedContent, filePath, viewMode, comments
- Exposed ref methods: goToNextChange, goToPreviousChange, getEditor, getScrollTop, setScrollTop, getCursorPosition
- ILineChange shape: {originalStartLineNumber, originalEndLineNumber, modifiedStartLineNumber, modifiedEndLineNumber, charChanges}
- For pure insertions: originalEndLineNumber=0, originalStartLineNumber=line before gap; for pure deletions: modifiedEndLineNumber=0
- collapseRegions.ts exports computeCollapseRegions() and CollapseRegion type for computing hidden areas

---

## 2026-02-06 - US-001
- Implemented `computeCollapseRegions()` utility in `src/components/Monaco/collapseRegions.ts`
- Pure function takes `ILineChange[]`, original/modified line counts → returns `{ original: CollapseRegion[], modified: CollapseRegion[] }`
- Handles 5 lines of context around each change, merges overlapping/adjacent visible regions
- Handles edge cases: changes at line 1 (no context above), changes at last line (no context below), files with no changes (collapse entire file)
- For insertions/deletions where `end === 0`, anchors context around the `start` line (line before the gap)
- Files changed: `src/components/Monaco/collapseRegions.ts` (new)
- **Learnings for future iterations:**
  - Monaco `ILineChange` has `originalStartLineNumber/originalEndLineNumber/modifiedStartLineNumber/modifiedEndLineNumber`
  - For pure insertions: `originalEndLineNumber === 0`, `originalStartLineNumber` = line before insertion point
  - For pure deletions: `modifiedEndLineNumber === 0`, `modifiedStartLineNumber` = line before deletion point
  - All Monaco line numbers are 1-based
---

