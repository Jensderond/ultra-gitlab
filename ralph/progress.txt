## Codebase Patterns
- Settings use `tauri-plugin-store` (JSON file), not SQLite. Add new fields by: adding store key const, load block in `load_settings()`, set call in `save_settings()`, field in `AppSettings` struct + Default impl.
- New command files in `src-tauri/src/commands/` need 3 registrations: pub mod + pub use in `mod.rs`, import + generate_handler! in `lib.rs`.
- Use `pub(crate)` visibility for helper functions shared between command modules (e.g., `load_settings`, `save_settings`, `settings_cache`).
- `#[serde(rename_all = "camelCase")]` on all DTOs sent to frontend.
- `AppError` has convenience constructors like `invalid_input_field()`, `not_found_with_id()`, etc.
- Transport layer: `src/services/transport.ts` detects Tauri vs browser via `window.__TAURI_INTERNALS__`. `tauri.ts` uses `transportInvoke` instead of direct `@tauri-apps/api` invoke.
- All `@tauri-apps/` imports should be dynamic — any new feature using Tauri APIs must follow this pattern.
- Package manager: bun (not npm/yarn). Typecheck: `bunx tsc --noEmit`.
- Pierre diffs: Worker pool controls theme/tokenizeMaxLineLength. Vite worker uses `?worker&url` import suffix.
- Pierre renders `<diffs-container>` custom element with Shadow DOM — scope Playwright selectors accordingly.
- Playwright: use `.mr-detail-sidebar` to scope file list selectors; use `{ exact: true }` for `getByText()`.
- Two diff viewer consumers: `MRDetailPage/MRDiffContent.tsx` and `MyMRDetailPage/CodeTab.tsx`.
- Playwright tests use mock data from `e2e/fixtures/seed-data.ts` and `e2e/fixtures/tauri-mock.ts` — no real Tauri backend needed.
- Test base fixture at `e2e/fixtures/test-base.ts` provides the standard test setup.
- Follow patterns in existing specs (e.g., `e2e/mr-detail.spec.ts`) for navigating to pages.
- Comment types in `src/types/index.ts`: Comment, AddCommentRequest, ReplyToCommentRequest, ResolveDiscussionRequest, DeleteCommentRequest.
- Service wrappers in `src/services/tauri.ts`: getComments, addComment, replyToComment, resolveDiscussion, deleteComment.
- High-level API in `src/services/gitlab.ts`: listComments, addGeneralComment, addInlineComment, deleteComment.
- Thread grouping pattern in `src/pages/MyMRDetailPage/useMyMRData.ts`: groups by discussionId, sorts unresolved first.
- Existing unused CommentPanel components in `src/components/CommentPanel/` — available for reference but not recommended for reuse.
- MRDetailPage uses Kanagawa Wave theme with glassmorphism, gradients, and wave animations.
- MRDetailPage footer shows keyboard shortcuts hint — toggle button should be added here.
- ActivityDrawer z-index must be below footer/header (z-index: 10) to avoid pointer interception. Use z-index: 9.
- Fixed overlays that sit at bottom: 0 will cover the footer — offset with `bottom: 49px` (footer height).
- MRDetailPage footer now has `display: flex; justify-content: space-between` to accommodate the activity toggle button.

---

## 2026-02-21 - US-001
- Implemented `useActivityData` hook at `src/hooks/useActivityData.ts`
- Fetches comments via `getComments(mrId)` and current user via `getGitLabInstances()`
- Groups non-system comments by `discussionId` into `Comment[][]` threads
- Separates system comments into `systemEvents` array sorted by creation time
- Sorts threads: unresolved first, then by oldest first
- Computes `unresolvedCount` for threads with a `discussionId` that aren't resolved
- Exposes `addComment`, `replyToComment`, `resolveDiscussion`, `deleteComment` with optimistic updates
- On mutation failure, rolls back optimistic state
- Files changed: `src/hooks/useActivityData.ts` (new)
- **Learnings for future iterations:**
  - No barrel `index.ts` in `src/hooks/` — hooks are imported directly by path
  - Thread grouping logic follows same pattern as `useMyMRData.ts` — reuses `discussionId ?? standalone-${id}` key pattern
  - Current user obtained from `getGitLabInstances()[0].authenticatedUsername`
  - Optimistic IDs use `-Date.now()` to avoid collision with real IDs
---

## 2026-02-21 - US-002
- Created `ActivityDrawer` component at `src/components/ActivityDrawer/`
  - `ActivityDrawer.tsx`: bottom overlay panel with open/close state, header with title and close button, scrollable content area
  - `ActivityDrawer.css`: Kanagawa Wave glassmorphism theme, slide-up CSS transition, custom scrollbar
  - `index.ts`: barrel export
- Integrated into `MRDetailPage/index.tsx`: added `activityOpen` state, ActivityDrawer component, and toggle button in footer
- Added `activity-toggle-btn` styles to `MRDetailPage.css`, made footer flex with space-between
- Created `e2e/activity-drawer.spec.ts` with 7 tests covering: hidden by default, toggle open/close, close button, title, scrollable content, overlay (no shrink), CSS transition
- Files changed: `src/components/ActivityDrawer/ActivityDrawer.tsx` (new), `src/components/ActivityDrawer/ActivityDrawer.css` (new), `src/components/ActivityDrawer/index.ts` (new), `src/pages/MRDetailPage/index.tsx` (modified), `src/pages/MRDetailPage.css` (modified), `e2e/activity-drawer.spec.ts` (new)
- **Learnings for future iterations:**
  - Drawer z-index must be < 10 (footer/header z-index) to avoid intercepting pointer events on footer buttons
  - Use `bottom: 49px` to position drawer above the footer (14px padding * 2 + ~21px text height)
  - Playwright fails with "subtree intercepts pointer events" when an overlay covers the click target — fix layout z-stacking, don't use `{ force: true }`
  - Footer was not flex before — added `display: flex; justify-content: space-between` to accommodate toggle button alongside keyboard hints
  - Component barrel exports follow `export { default as ComponentName }` pattern
---
