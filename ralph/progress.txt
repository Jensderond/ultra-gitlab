## Codebase Patterns
- MonacoDiffViewer is at src/components/Monaco/MonacoDiffViewer.tsx — forwardRef component with imperative ref API
- Monaco options configured in the component: folding: true, showFoldingControls: "always", splitView with viewMode prop
- Key Monaco APIs: editor.getLineChanges(), getOriginalEditor(), getModifiedEditor(), setHiddenAreas()
- ViewZone API for injecting custom DOM between editor lines
- Kanagawa theme defined in src/components/Monaco/kanagawaTheme.ts with diff-specific colors
- Monaco CSS in src/components/Monaco/monaco.css (comment decorations, glyph styles)
- Language detection in src/components/Monaco/languageDetection.ts
- Component used in MRDetailPage.tsx with props: originalContent, modifiedContent, filePath, viewMode, comments
- Exposed ref methods: goToNextChange, goToPreviousChange, getEditor, getScrollTop, setScrollTop, getCursorPosition
- ILineChange shape: {originalStartLineNumber, originalEndLineNumber, modifiedStartLineNumber, modifiedEndLineNumber, charChanges}
- For pure insertions: originalEndLineNumber=0, originalStartLineNumber=line before gap; for pure deletions: modifiedEndLineNumber=0
- collapseRegions.ts exports computeCollapseRegions() and CollapseRegion type for computing hidden areas
- **CRITICAL**: Monaco v0.55+ has built-in `hideUnchangedRegions` option on DiffEditor — it handles setHiddenAreas, ViewZones, expand controls, and sync between editors automatically
- hideUnchangedRegions config: { enabled, contextLineCount (context lines around changes), minimumLineCount (min hidden to collapse), revealLineCount (lines revealed per expand click) }
- The built-in feature internally uses setHiddenAreas() on both editors, creates ViewZone widgets with expand up/down/all controls
- CSS classes for styling: `.diff-hidden-lines-widget`, `.diff-hidden-lines-compact`, `.diff-unchanged-lines`, `.fold-unchanged`
- Theme color keys for fold zone styling: `diffEditor.unchangedRegionBackground`, `diffEditor.unchangedRegionForeground`, `diffEditor.unchangedRegionShadow`, `diffEditor.unchangedCodeBackground`
- CSS overrides for fold zones go in monaco.css targeting `.monaco-editor .diff-hidden-lines .center` (the bar), `.top`/`.bottom` (drag handles), `.center a` (expand links)
- **Top/bottom handles support click-to-reveal**: click (no drag) calls showMoreAbove/showMoreBelow with revealLineCount (20), drag reveals incrementally by mouse delta / lineHeight
- Monaco handles scroll position stability on bottom expand (saves/restores scrollTop around the reveal)

---

## 2026-02-06 - US-001
- Implemented `computeCollapseRegions()` utility in `src/components/Monaco/collapseRegions.ts`
- Pure function takes `ILineChange[]`, original/modified line counts → returns `{ original: CollapseRegion[], modified: CollapseRegion[] }`
- Handles 5 lines of context around each change, merges overlapping/adjacent visible regions
- Handles edge cases: changes at line 1 (no context above), changes at last line (no context below), files with no changes (collapse entire file)
- For insertions/deletions where `end === 0`, anchors context around the `start` line (line before the gap)
- Files changed: `src/components/Monaco/collapseRegions.ts` (new)
- **Learnings for future iterations:**
  - Monaco `ILineChange` has `originalStartLineNumber/originalEndLineNumber/modifiedStartLineNumber/modifiedEndLineNumber`
  - For pure insertions: `originalEndLineNumber === 0`, `originalStartLineNumber` = line before insertion point
  - For pure deletions: `modifiedEndLineNumber === 0`, `modifiedStartLineNumber` = line before deletion point
  - All Monaco line numbers are 1-based
---

## 2026-02-06 - US-002
- Enabled Monaco's built-in `hideUnchangedRegions` feature on the DiffEditor in `MonacoDiffViewer.tsx`
- Configuration: `{ enabled: true, contextLineCount: 5, minimumLineCount: 3, revealLineCount: 20 }`
- This replaces the need for manually calling `setHiddenAreas()` — Monaco internally handles:
  - Computing unchanged regions from the diff
  - Applying hidden areas on both original and modified editors
  - Maintaining line number alignment
  - Preserving syntax highlighting (full model preserved, view layer only)
  - Files with no changes are collapsed
- Files changed: `src/components/Monaco/MonacoDiffViewer.tsx` (modified)
- **Learnings for future iterations:**
  - Monaco v0.55+ `hideUnchangedRegions` option does what the PRD described with `setHiddenAreas()` but as a built-in, well-tested feature
  - The feature also provides ViewZone widgets with expand controls (up/down/all), removing the need to implement US-003/004/005 from scratch
  - `contextLineCount: 5` matches the PRD's "5 lines of context" requirement
  - `revealLineCount: 20` matches the PRD's "+20 lines" incremental expand requirement
  - `minimumLineCount: 3` prevents collapsing tiny unchanged regions that aren't worth hiding
  - The built-in feature works in both split and unified view modes automatically
  - Remaining work: custom styling (US-003/008) to match Kanagawa theme, toolbar buttons (US-006), state persistence (US-007)
---

## 2026-02-06 - US-003
- Styled Monaco's built-in `hideUnchangedRegions` ViewZone widgets to match Kanagawa theme
- Added theme colors in `kanagawaTheme.ts`: `diffEditor.unchangedRegionBackground` (#2a2a37), `diffEditor.unchangedRegionForeground` (#727169), `diffEditor.unchangedRegionShadow` (#16161d), `diffEditor.unchangedCodeBackground` (transparent), `focusBorder` and `editorLink.activeForeground` (#7e9cd8)
- Added CSS overrides in `monaco.css`: thin top/bottom borders (#363646), 12px font size, muted text color, no box shadow, Kanagawa blue hover accents on drag handles and expand links
- Files changed: `src/components/Monaco/kanagawaTheme.ts` (modified), `src/components/Monaco/monaco.css` (modified)
- **Learnings for future iterations:**
  - Monaco's built-in fold zone CSS uses `--vscode-*` CSS variables that map to theme color keys (e.g., `--vscode-diffEditor-unchangedRegionBackground` ← `diffEditor.unchangedRegionBackground` in theme)
  - The `.diff-hidden-lines .center` element is the main fold bar (24px tall), `.top`/`.bottom` are 4px drag handles, `.center a` contains expand controls
  - `!important` overrides are needed for `background`, `color`, `font-size`, and `box-shadow` because Monaco's default styles are also set with high specificity
  - Setting `diffEditor.unchangedCodeBackground` to transparent (`#1f1f2800`) avoids a visible tint on code near collapsed regions
---

## 2026-02-06 - US-004
- Verified Monaco's built-in expand-up/down controls already satisfy all acceptance criteria:
  - Top handle click → `showMoreAbove(revealLineCount=20)` reveals 20 lines above
  - Bottom handle click → `showMoreBelow(revealLineCount=20)` reveals 20 lines below
  - Fewer than 20 remaining → clamped to max, all revealed
  - Hidden line count updates automatically in center bar
  - Widget removed when fully expanded (built-in)
  - Symmetric on both original and modified editors (built-in)
  - Scroll position stable: bottom expand explicitly saves/restores scrollTop
  - Handles are transparent (subtle) by default, highlight with Kanagawa blue on hover
- Enhanced CSS for expand handles: added smooth transition on height, handles grow from 4px to 6px on hover for better discoverability
- Files changed: `src/components/Monaco/monaco.css` (modified), `ralph/prd.json` (updated)
- **Learnings for future iterations:**
  - Monaco's top/bottom drag handles have dual behavior: click (no mouse movement) triggers `showMoreAbove`/`showMoreBelow` with `revealLineCount`, drag reveals incrementally by pixel delta / lineHeight
  - The `didMove` flag (threshold: `Math.abs(delta) > 2`) distinguishes click from drag
  - Bottom expand includes scroll stabilization: captures `getTopForLineNumber(endLineExclusive)` before/after reveal, adjusts scrollTop by difference
  - The built-in hideUnchangedRegions feature handles US-004 and US-005 entirely — no custom code needed beyond CSS styling
---

