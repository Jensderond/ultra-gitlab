## Codebase Patterns
- Settings use `tauri-plugin-store` (JSON file), not SQLite. Add new fields by: adding store key const, load block in `load_settings()`, set call in `save_settings()`, field in `AppSettings` struct + Default impl.
- New command files in `src-tauri/src/commands/` need 3 registrations: pub mod + pub use in `mod.rs`, import + generate_handler! in `lib.rs`.
- Use `pub(crate)` visibility for helper functions shared between command modules (e.g., `load_settings`, `save_settings`, `settings_cache`).
- `#[serde(rename_all = "camelCase")]` on all DTOs sent to frontend.
- `AppError` has convenience constructors like `invalid_input_field()`, `not_found_with_id()`, etc.
- Transport layer: `src/services/transport.ts` detects Tauri vs browser via `window.__TAURI_INTERNALS__`. `tauri.ts` uses `transportInvoke` instead of direct `@tauri-apps/api` invoke.
- All `@tauri-apps/` imports should be dynamic — any new feature using Tauri APIs must follow this pattern.
- Package manager: bun (not npm/yarn). Typecheck: `bunx tsc --noEmit`.
- Pierre diffs: Worker pool controls theme/tokenizeMaxLineLength. Vite worker uses `?worker&url` import suffix.
- Pierre renders `<diffs-container>` custom element with Shadow DOM — scope Playwright selectors accordingly.
- Playwright: use `.mr-detail-sidebar` to scope file list selectors; use `{ exact: true }` for `getByText()`.
- Two diff viewer consumers: `MRDetailPage/MRDiffContent.tsx` and `MyMRDetailPage/CodeTab.tsx`.
- Playwright tests use mock data from `e2e/fixtures/seed-data.ts` and `e2e/fixtures/tauri-mock.ts` — no real Tauri backend needed.
- Test base fixture at `e2e/fixtures/test-base.ts` provides the standard test setup.
- Follow patterns in existing specs (e.g., `e2e/mr-detail.spec.ts`) for navigating to pages.
- Comment types in `src/types/index.ts`: Comment, AddCommentRequest, ReplyToCommentRequest, ResolveDiscussionRequest, DeleteCommentRequest.
- Service wrappers in `src/services/tauri.ts`: getComments, addComment, replyToComment, resolveDiscussion, deleteComment.
- High-level API in `src/services/gitlab.ts`: listComments, addGeneralComment, addInlineComment, deleteComment.
- Thread grouping pattern in `src/pages/MyMRDetailPage/useMyMRData.ts`: groups by discussionId, sorts unresolved first.
- Existing unused CommentPanel components in `src/components/CommentPanel/` — available for reference but not recommended for reuse.
- MRDetailPage uses Kanagawa Wave theme with glassmorphism, gradients, and wave animations.
- MRDetailPage footer shows keyboard shortcuts hint — toggle button should be added here.
- ActivityDrawer z-index must be below footer/header (z-index: 10) to avoid pointer interception. Use z-index: 9.
- Fixed overlays that sit at bottom: 0 will cover the footer — offset with `bottom: 49px` (footer height).
- MRDetailPage footer now has `display: flex; justify-content: space-between` to accommodate the activity toggle button.
- ActivityDrawer height controlled via inline style `height: Xvh` (useState). Default 40vh, min 20vh, max 80vh. Drag handle at top edge.
- ActivityFeed component at `src/components/ActivityDrawer/ActivityFeed.tsx` — takes `threads` and `loading` props, renders ThreadCard per thread.
- Seed data for MR 101 now includes: 4 unresolved threads, 1 resolved thread, 2 system events, 1 reply, 1 pending sync comment, 1 standalone comment.
- ActivityDrawer receives content via `children` prop — MRDetailPage passes `<ActivityFeed>` as children. Fixed-bottom content (CommentInput) goes in `footer` prop.
- ActivityDrawer CSS: `left: 56px` to offset for sidebar (56px wide, z-index: 100). Without this, sidebar intercepts pointer events on drawer content.
- When tracking "which thread is active" by state, never use `discussionId` (can be null for standalone comments causing `null === null` matches). Use the root comment `id` instead.

---

## 2026-02-21 - US-001
- Implemented `useActivityData` hook at `src/hooks/useActivityData.ts`
- Fetches comments via `getComments(mrId)` and current user via `getGitLabInstances()`
- Groups non-system comments by `discussionId` into `Comment[][]` threads
- Separates system comments into `systemEvents` array sorted by creation time
- Sorts threads: unresolved first, then by oldest first
- Computes `unresolvedCount` for threads with a `discussionId` that aren't resolved
- Exposes `addComment`, `replyToComment`, `resolveDiscussion`, `deleteComment` with optimistic updates
- On mutation failure, rolls back optimistic state
- Files changed: `src/hooks/useActivityData.ts` (new)
- **Learnings for future iterations:**
  - No barrel `index.ts` in `src/hooks/` — hooks are imported directly by path
  - Thread grouping logic follows same pattern as `useMyMRData.ts` — reuses `discussionId ?? standalone-${id}` key pattern
  - Current user obtained from `getGitLabInstances()[0].authenticatedUsername`
  - Optimistic IDs use `-Date.now()` to avoid collision with real IDs
---

## 2026-02-21 - US-002
- Created `ActivityDrawer` component at `src/components/ActivityDrawer/`
  - `ActivityDrawer.tsx`: bottom overlay panel with open/close state, header with title and close button, scrollable content area
  - `ActivityDrawer.css`: Kanagawa Wave glassmorphism theme, slide-up CSS transition, custom scrollbar
  - `index.ts`: barrel export
- Integrated into `MRDetailPage/index.tsx`: added `activityOpen` state, ActivityDrawer component, and toggle button in footer
- Added `activity-toggle-btn` styles to `MRDetailPage.css`, made footer flex with space-between
- Created `e2e/activity-drawer.spec.ts` with 7 tests covering: hidden by default, toggle open/close, close button, title, scrollable content, overlay (no shrink), CSS transition
- Files changed: `src/components/ActivityDrawer/ActivityDrawer.tsx` (new), `src/components/ActivityDrawer/ActivityDrawer.css` (new), `src/components/ActivityDrawer/index.ts` (new), `src/pages/MRDetailPage/index.tsx` (modified), `src/pages/MRDetailPage.css` (modified), `e2e/activity-drawer.spec.ts` (new)
- **Learnings for future iterations:**
  - Drawer z-index must be < 10 (footer/header z-index) to avoid intercepting pointer events on footer buttons
  - Use `bottom: 49px` to position drawer above the footer (14px padding * 2 + ~21px text height)
  - Playwright fails with "subtree intercepts pointer events" when an overlay covers the click target — fix layout z-stacking, don't use `{ force: true }`
  - Footer was not flex before — added `display: flex; justify-content: space-between` to accommodate toggle button alongside keyboard hints
  - Component barrel exports follow `export { default as ComponentName }` pattern
---

## 2026-02-21 - US-003
- Added drag-to-resize handle to `ActivityDrawer` component
  - Visual grip indicator (4px rounded bar) at the top edge of the drawer
  - Mouse drag on handle resizes drawer height, clamped between 20vh and 80vh
  - Default height 40vh, persists within session (useState)
  - `ns-resize` cursor on hover, body cursor override during drag
- Updated `ActivityDrawer.css` with drag handle and grip styles
- Added 5 new Playwright tests: handle visibility, grip indicator, drag resize, min/max clamping, session persistence
- Files changed: `src/components/ActivityDrawer/ActivityDrawer.tsx` (modified), `src/components/ActivityDrawer/ActivityDrawer.css` (modified), `e2e/activity-drawer.spec.ts` (modified)
- **Learnings for future iterations:**
  - When computing height in `vh` from mouse position, divide by `window.innerHeight` (not `availableHeight`) since vh is a percentage of the full viewport
  - Footer height is 49px — subtract from mouse-to-bottom calculation for accurate drawer sizing
  - Use `document.body.style.userSelect = 'none'` during drag to prevent text selection
  - Playwright mouse drag: use `page.mouse.move(x, y, { steps: 5 })` for reliable drag simulation
  - Height set via inline style overrides CSS `height` — removed hardcoded `40vh` from CSS
---

## 2026-02-21 - US-004
- Wired `useActivityData(mrId)` into `MRDetailPage/index.tsx` for `unresolvedCount`
- Added Cmd+D keyboard shortcut via `useEffect` with `keydown` listener checking `e.metaKey && e.key === 'd'`
- Shortcut skips when `e.target` tagName is INPUT or TEXTAREA
- Added unresolved badge (`<span className="activity-badge">`) to activity toggle button, hidden when count is 0
- Added `.activity-badge` CSS styles in `MRDetailPage.css` (pill badge using `var(--accent-color)`)
- Added 4 new Playwright tests: Cmd+D toggle, Cmd+D skip in input, badge shows count, badge hidden when 0
- Files changed: `src/pages/MRDetailPage/index.tsx` (modified), `src/pages/MRDetailPage.css` (modified), `e2e/activity-drawer.spec.ts` (modified)
- **Learnings for future iterations:**
  - Cmd+D (meta key shortcuts) should be handled separately from `useMRKeyboard` which only handles single-key shortcuts
  - The pre-existing drag resize test is flaky — sometimes returns exact same height due to race conditions
  - Seed data for MR 101 has 4 unique discussionIds, all unresolved — `unresolvedCount` = 4
  - For testing "badge hidden when 0", navigate to a non-existent MR (e.g., /mrs/999) which returns empty comments
---

## 2026-02-21 - US-005
- Created `ActivityFeed` component at `src/components/ActivityDrawer/ActivityFeed.tsx`
  - Renders discussion threads with root comment and replies
  - Shows author username, relative timestamp, and comment body
  - Inline threads display file path and line number above the thread
  - Resolved threads visually dimmed (opacity 0.5) with hover restore
  - Threads ordered: unresolved first, then resolved, then by creation time
  - Loading spinner while fetching, empty state when no comments
- Created `ActivityFeed.css` with Kanagawa Wave theme styling
- Updated `ActivityDrawer/index.ts` barrel export to include `ActivityFeed`
- Integrated into `MRDetailPage/index.tsx`: passes `activityThreads` and `activityLoading` from `useActivityData` to `<ActivityFeed>` as children of `<ActivityDrawer>`
- Enhanced seed data (`e2e/fixtures/seed-data.ts`) for MR 101:
  - Added reply (id: 5005, alice replies to disc-001)
  - Added resolved thread (id: 5006, disc-005, carol)
  - Added 2 system events (id: 5007 approval, id: 5008 commits)
  - Added pending sync standalone comment (id: 5009)
- Added 9 new Playwright tests covering: feed rendering, author/body, timestamps, inline file info, resolved dimming, ordering, replies, empty state, loading
- Files changed: `src/components/ActivityDrawer/ActivityFeed.tsx` (new), `src/components/ActivityDrawer/ActivityFeed.css` (new), `src/components/ActivityDrawer/index.ts` (modified), `src/pages/MRDetailPage/index.tsx` (modified), `e2e/fixtures/seed-data.ts` (modified), `e2e/activity-drawer.spec.ts` (modified)
- **Learnings for future iterations:**
  - ActivityDrawer receives children — compose content by passing components as children rather than props
  - Seed data for MR 101 now has 6 non-system threads (4 unresolved + 1 standalone + 1 resolved) and 2 system events — unresolvedCount still 4 (standalone has no discussionId)
  - `formatRelativeTime` helper converts Unix timestamps to "Xm ago" / "Xh ago" / "Xd ago" format
  - Thread sorting: `useMemo` in `useActivityData` handles ordering (unresolved first, then chronological)
  - System events toggle: `showSystemEvents` state lives in `MRDetailPage`, passed through `ActivityDrawer` and `ActivityFeed` as props.
  - Feed interleaving: When system events visible, `FeedItem` union type + sort in `useMemo` handles chronological interleave with unresolved-first priority.
---

## 2026-02-21 - US-006
- Added system events display with show/hide toggle to ActivityDrawer
  - `SystemEventEntry` component in `ActivityFeed.tsx`: compact single-line entries with muted styling
  - "Show activity" checkbox toggle in the drawer header (hidden by default)
  - System events interleaved chronologically with comment threads when visible
  - `FeedItem` union type enables mixed rendering of threads and events
  - `useMemo` sort: unresolved threads first, then chronological interleave
- Updated `ActivityDrawer.tsx`: added `showSystemEvents` and `onToggleSystemEvents` props, header now has actions area with toggle + close button
- Updated `ActivityDrawer.css`: styles for header actions, toggle label/checkbox
- Updated `ActivityFeed.css`: styles for system event entries (compact, muted, border-left indicator)
- Updated `MRDetailPage/index.tsx`: added `showSystemEvents` state, passes `systemEvents` from `useActivityData` through to `ActivityFeed`
- Added 7 new Playwright tests covering: hidden by default, toggle presence, reveal on toggle, author/body display, interleaving count, toggle off, muted styling
- Files changed: `src/components/ActivityDrawer/ActivityFeed.tsx` (modified), `src/components/ActivityDrawer/ActivityFeed.css` (modified), `src/components/ActivityDrawer/ActivityDrawer.tsx` (modified), `src/components/ActivityDrawer/ActivityDrawer.css` (modified), `src/pages/MRDetailPage/index.tsx` (modified), `e2e/activity-drawer.spec.ts` (modified)
- **Learnings for future iterations:**
  - When adding new props to ActivityDrawer, all consumers (MRDetailPage) must be updated
  - FeedItem union type pattern works well for mixed-type feed rendering with `kind` discriminator
  - System events use `data-testid="activity-system-event"` — distinct from `activity-thread`
  - Header actions grouped in `activity-drawer__header-actions` flex container to keep title on left
---

## 2026-02-21 - US-007
- Created `CommentInput` component at `src/components/ActivityDrawer/CommentInput.tsx`
  - Textarea with placeholder "Add a comment...", send button, Cmd+Enter shortcut
  - Disabled state during submission, auto-clears and refocuses after submit
- Created `CommentInput.css` with Kanagawa Wave theme (glassmorphism border-top, accent send button)
- Added `footer` prop to `ActivityDrawer` to render CommentInput below the scrollable content
- Wired `activityAddComment` from `useActivityData` into `MRDetailPage` → `CommentInput`
- Updated barrel export in `ActivityDrawer/index.ts`
- Added 7 new Playwright tests: input visibility, send disabled/enabled, submit via button, submit via Cmd+Enter, fixed at bottom (not scrolling), pending sync
- Files changed: `src/components/ActivityDrawer/CommentInput.tsx` (new), `src/components/ActivityDrawer/CommentInput.css` (new), `src/components/ActivityDrawer/index.ts` (modified), `src/components/ActivityDrawer/ActivityDrawer.tsx` (modified), `src/pages/MRDetailPage/index.tsx` (modified), `e2e/activity-drawer.spec.ts` (modified)
- **Learnings for future iterations:**
  - ActivityDrawer uses `footer` prop (not children) for fixed-at-bottom content — content area scrolls, footer stays pinned
  - CommentInput submit pattern: `(e.metaKey || e.ctrlKey) && e.key === 'Enter'` for cross-platform Cmd+Enter
  - Optimistic comments from `addComment` have negative IDs (`-Date.now()`) and `syncStatus: 'pending'`
  - The tauri mock's `add_comment` returns a mock comment — optimistic update gets replaced by mock response
---

## 2026-02-21 - US-008
- Added reply-to-thread functionality in the activity drawer
  - `ReplyInput` component in `ActivityFeed.tsx`: inline textarea with auto-focus, Cmd+Enter submit, Cancel/Send buttons, Escape to close
  - `ThreadCard` updated: Reply button shown on threads with `discussionId`, tracks which thread has reply input open via root comment ID
  - Only one reply input open at a time — opening a new one closes the previous
  - Reply submitted via `onReply` callback prop wired through from `useActivityData.replyToComment`
  - Optimistic update: reply appears immediately in the thread
- Fixed ActivityDrawer `left: 0` → `left: 56px` to offset for sidebar, preventing pointer event interception on drawer content
- Added CSS for `.activity-thread__reply-btn` and `.activity-reply-input` with Kanagawa Wave theme
- Added 7 new Playwright tests: reply button presence, open/close, only-one-at-a-time, submit via button, submit via Cmd+Enter, auto-focus
- Files changed: `src/components/ActivityDrawer/ActivityFeed.tsx` (modified), `src/components/ActivityDrawer/ActivityFeed.css` (modified), `src/components/ActivityDrawer/ActivityDrawer.css` (modified), `src/pages/MRDetailPage/index.tsx` (modified), `e2e/activity-drawer.spec.ts` (modified)
- **Learnings for future iterations:**
  - Never track "active thread" by `discussionId` — standalone comments have `null` discussionId, causing `null === null` false matches. Use root comment `id` instead.
  - ActivityDrawer was positioned at `left: 0` which let the sidebar (56px, z-index: 100) intercept pointer events on drawer content. Fixed to `left: 56px`.
  - ReplyInput follows same Cmd+Enter pattern as CommentInput but also supports Escape to cancel
  - `reply_to_comment` mock returns a fixed response — optimistic update gets replaced by mock response
---
