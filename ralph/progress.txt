## Codebase Patterns
- Settings use `tauri-plugin-store` (JSON file), not SQLite. Add new fields by: adding store key const, load block in `load_settings()`, set call in `save_settings()`, field in `AppSettings` struct + Default impl.
- New command files in `src-tauri/src/commands/` need 3 registrations: pub mod + pub use in `mod.rs`, import + generate_handler! in `lib.rs`.
- Use `pub(crate)` visibility for helper functions shared between command modules (e.g., `load_settings`, `save_settings`, `settings_cache`).
- `#[serde(rename_all = "camelCase")]` on all DTOs sent to frontend.
- `AppError` has convenience constructors like `invalid_input_field()`, `not_found_with_id()`, etc.
- Companion server service: `services::companion_server` has `start_companion_server()`, `stop_companion_server()`, `is_companion_server_running()`.
- Frontend dist path: In dev mode, `CARGO_MANIFEST_DIR/../dist`; in prod, Tauri resource dir. Both checked via `index.html` existence.
- Transport layer: `src/services/transport.ts` detects Tauri vs browser via `window.__TAURI_INTERNALS__`. `tauri.ts` uses `transportInvoke` instead of direct `@tauri-apps/api` invoke. `isTauri` exported from `services/index.ts`.
- All `@tauri-apps/` imports should be dynamic — any new feature using Tauri APIs must follow this pattern.
- `tauriListen()` and `openExternalUrl()` in `transport.ts` handle Tauri vs browser seamlessly.
- Package manager: bun (not npm/yarn). Typecheck: `bunx tsc --noEmit`.

- When replacing `dangerouslySetInnerHTML` with SVG content, use `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}` as an `<img>` src — avoids XSS while preserving visual output.
- To replace `useEffect(() => setState(x), [dep])` derived state pattern: use a ref to track the previous value and reset during render with guards (e.g., `if (dep !== prevRef.current) { prevRef.current = dep; setState(x); }`).
- Settings page is now at `src/pages/Settings/` (directory with index.tsx orchestrator). Sub-components are in the same directory. CSS is still at `src/pages/Settings.css`.
- When decomposing a page: keep the CSS file in its original location, import with `../Settings.css` from the new directory. Delete the old monolithic `.tsx` file so the directory `index.tsx` takes priority.
- When extracting data-loading hooks that need callbacks from other hooks (circular dependency), use a `useRef<() => void>(() => {})` and wire `.current` after both hooks have run.

---

## 2026-02-18 - US-001
- Replaced `dangerouslySetInnerHTML={{ __html: qrSvg }}` with safe `<img>` element using data URI
- Changed `<div>` to `<img>` with `alt` text for accessibility
- Updated CSS: removed `display: flex`, child `svg` selector (no longer needed with `<img>`), added `box-sizing: content-box`
- Files changed: `src/pages/Settings.tsx`, `src/pages/Settings.css`
- **Learnings for future iterations:**
  - QR SVG is generated by Rust backend via `getCompanionQrSvg()` — it's trusted content, but `dangerouslySetInnerHTML` is still an anti-pattern
  - CSS had `.companion-qr-code svg` child selector that targeted inline SVG — switching to `<img>` requires removing those child selectors
  - Data URI approach: `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgString)}` works well for trusted SVG rendering
---

## 2026-02-18 - US-002
- Created `src/hooks/useCompanionAuth.ts` — encapsulates the `fetch('/api/instances')` session check
- Hook returns `{ isAuthenticated: boolean | null, isChecking: boolean }`, accepts `skip` param
- Updated `src/App.tsx` to use `useCompanionAuth(isTauri || location.pathname === '/auth')` instead of inline fetch-in-useEffect
- Updated `src/pages/AuthPage.tsx` to use `useCompanionAuth()` instead of inline session check
- Both callers use separate useEffects to react to auth state (navigate on auth result)
- Files changed: `src/hooks/useCompanionAuth.ts` (new), `src/App.tsx`, `src/pages/AuthPage.tsx`
- **Learnings for future iterations:**
  - The two auth checks had subtly different behaviors: App.tsx redirects to `/auth` on failure, AuthPage redirects to `/mrs` on success — the hook must return the raw state so callers can decide
  - The `skip` parameter is important — App.tsx needs to skip the check when running in Tauri mode or when already on the auth page
  - `browserAuthChecked` state in App.tsx was initialized to `isTauri` (true in desktop mode) — the replacement uses `!isTauri && companionAuth.isAuthenticated !== true` guard
---


## 2026-02-18 - US-003
- Replaced two `useEffect` anti-patterns in `CommandPalette.tsx`:
  1. `useEffect(() => setSelectedIndex(0), [query])` → inline render-time check using `prevQueryRef`
  2. `useEffect(() => { setQuery(''); setSelectedIndex(0); focus(); }, [isOpen])` → split into: render-time state reset via `prevIsOpenRef` transition detection + retained `useEffect` only for DOM focus
- Files changed: `src/components/CommandPalette/CommandPalette.tsx`
- **Learnings for future iterations:**
  - The "reset state on prop change" useEffect pattern is replaced by tracking previous values with refs and doing conditional setState during render — React handles the re-render correctly
  - Guard setState calls with value checks (e.g., `if (selectedIndex !== 0)`) to avoid unnecessary re-renders when state already has the target value
  - DOM side effects (focus, scroll) still need useEffect — only state derivation moves to render
---

## 2026-02-18 - US-004
- Replaced array-index keys with stable unique keys in 4 files:
  - `CommandItem.tsx`: shortcut parts use the part string itself as key (parts are unique within a shortcut)
  - `Settings.tsx`: pattern list uses `${index}-${pattern}` composite key (patterns can be duplicated/edited)
  - `DiffViewer.tsx`: null hunks use `loading-${index}`, real hunks use `${oldStart}-${newStart}`
  - `JobLogPage.tsx`: ANSI segments use text offset as key; log entries use `line-${lineNumber}` or `section-${name}`
- Files changed: `src/components/CommandPalette/CommandItem.tsx`, `src/pages/Settings.tsx`, `src/components/DiffViewer/DiffViewer.tsx`, `src/pages/JobLogPage.tsx`
- **Learnings for future iterations:**
  - For ANSI segments without IDs, accumulating a text offset produces a stable key since segments are parsed deterministically
  - DiffHunk's `oldStart`/`newStart` pair uniquely identifies a hunk — good stable key
  - LogEntry lines have `lineNumber`, sections have `name` — both are unique within a parsed log
  - When items can be duplicated (like editable pattern strings), a composite `${index}-${value}` key is the best compromise
---

## 2026-02-18 - US-005
- Removed 11 dead source files (8 .ts/.tsx + 3 .css):
  - `src/hooks/useSyncStatus.ts` — unused hook
  - `src/themes/index.ts` — barrel file, other files import theme sub-modules directly
  - `src/components/InstanceSetup/index.ts` — barrel file, Settings imports InstanceSetup directly
  - `src/components/Monaco/collapseRegions.ts` — unused utility
  - `src/components/SyncStatus/` — entire directory removed (PendingActionsIndicator, SyncLogPanel, SyncStatusBar + their CSS + index.ts)
- Files changed: 11 files deleted, 1257 lines removed
- **Learnings for future iterations:**
  - The SyncStatus components formed a self-contained island — all internal imports (useSyncStatus hook, sibling components) were only referenced within the cluster itself. Safe to remove as a unit.
  - `themes/index.ts` was a dead barrel — other files import specific sub-modules (deriveTheme, types, kanagawa-wave, monacoAdapter) directly
  - `InstanceSetup/index.ts` was bypassed — Settings imports `InstanceSetup/InstanceSetup` directly
---

## 2026-02-18 - US-006
- Replaced barrel import `import { CommentInput } from './index'` with direct import `import CommentInput from './CommentInput'` in InlineComment.tsx
- Files changed: `src/components/CommentPanel/InlineComment.tsx`
- **Learnings for future iterations:**
  - CommentInput uses `export default` — direct import uses default import syntax (no braces), unlike the named re-export from the barrel
  - The barrel `index.ts` re-exports with `export { default as CommentInput }` — consumers within the same directory should import directly to avoid circular dependency risk and improve tree-shaking
---

## 2026-02-18 - US-007
- Converted `renderSegments()` helper in JobLogPage.tsx to a proper named component `AnsiSegments` that returns a fragment with the segment spans
- Changed `useState(ACTIVE_STATUSES.has(initialStatus))` to lazy initializer `useState(() => ACTIVE_STATUSES.has(initialStatus))`
- Removed unnecessary `useMemo` wrappers from `unresolvedCount` and `approvedCount` in MyMRDetailPage.tsx — these were trivially cheap `.filter().length` calls
- DiffLine.tsx:122 `renderHighlightedContent()` referenced in PRD no longer exists — the file is 89 lines with no inline render functions
- Files changed: `src/pages/JobLogPage.tsx`, `src/pages/MyMRDetailPage.tsx`
- **Learnings for future iterations:**
  - When converting a render helper to a component, wrap the returned array in a `<>...</>` fragment
  - PRD line numbers become stale after previous stories modify files — always search for the actual function/pattern name rather than relying on line numbers
  - `useMemo` around `.filter().length` on small arrays (reviewers, threads) is unnecessary overhead — only memoize expensive computations
---

## 2026-02-18 - US-008
- Decomposed monolithic `src/pages/Settings.tsx` (1505 lines) into `src/pages/Settings/` directory with 12 focused sub-components
- Created orchestrator `index.tsx` (70 lines) that imports and renders all sections
- Extracted components:
  - `UpdatesSection.tsx` (88 lines) — version info and update downloads
  - `InstancesSection.tsx` (113 lines) — instance list management
  - `InstanceItem.tsx` (147 lines) — single instance row with inline token editing
  - `SyncSettingsSection.tsx` (142 lines) — sync interval and scope
  - `CompanionServerSection.tsx` (210 lines) — companion server toggle, port config
  - `CompanionActivePanel.tsx` (57 lines) — QR code, PIN, device list when server is on
  - `CompanionDeviceList.tsx` (55 lines) — authorized device list with revoke
  - `AppearanceSection.tsx` (212 lines) — theme swatches, custom theme editor, font selector
  - `NotificationsSection.tsx` (122 lines) — notification toggles
  - `CollapsePatternsEditor.tsx` (128 lines) — file collapse pattern management
  - `ShortcutEditor.tsx` (239 lines) — keyboard shortcut customization
- Deleted old `src/pages/Settings.tsx`
- CSS stays at `src/pages/Settings.css` (imported via `../Settings.css` from the new directory)
- `App.tsx` import `'./pages/Settings'` resolves to directory `index.tsx` automatically
- Files changed: 1 deleted, 12 created
- **Learnings for future iterations:**
  - When converting `src/pages/Foo.tsx` to `src/pages/Foo/index.tsx`, existing imports like `'./pages/Foo'` resolve automatically — no import changes needed in consumers
  - The old `.tsx` file MUST be deleted or it will take priority over the directory's `index.tsx`
  - Token editing state (editingTokenId, tokenInput, etc.) was lifted to the parent InstancesSection — better to push it down into `InstanceItem` so each item owns its edit state independently
  - Components like CompanionServerSection that have "enabled" content panels benefit from extracting the active-state content into a separate presentational component
---

## 2026-02-18 - US-009
- Fixed label/control associations in 3 Settings sub-components:
  - `CompanionActivePanel.tsx`: Changed `<label>` to `<span>` for "PIN Code" (display-only, not a form control)
  - `AppearanceSection.tsx`: Changed `<label>` to `<span>` with `id` for "UI Font", added `role="group" aria-labelledby` to the font options container
  - `SyncSettingsSection.tsx`: Replaced `<div>/<label>` with `<fieldset>/<legend>` for "Sync Scope" checkbox group; added CSS reset for fieldset defaults
- Moved QR SVG fetching from useEffect (reacting to settings changes) to explicit calls in event handlers (`loadSettings`, `handleToggle`, `handlePortBlur`, `handleRegeneratePin`)
- Reviewed 3 autoFocus instances — all justified (user-initiated edit mode), added comments explaining rationale
- Removed redundant `inputRef` + `setTimeout(() => focus(), 0)` in `InstanceItem.tsx` since `autoFocus` already handles focus
- Files changed: `CompanionActivePanel.tsx`, `AppearanceSection.tsx`, `SyncSettingsSection.tsx`, `CompanionServerSection.tsx`, `InstanceItem.tsx`, `ShortcutEditor.tsx`, `CollapsePatternsEditor.tsx`, `Settings.css`
- **Learnings for future iterations:**
  - Labels (`<label>`) should only be used for actual form controls — for display-only content or button groups, use `<span>` with `aria-labelledby` or `<fieldset>/<legend>`
  - When a useEffect fetches data based on state that only changes in event handlers, move the fetch into those handlers directly — eliminates the "useEffect simulating event handler" pattern
  - `autoFocus` on inputs that appear after user action (click to edit) is correct UX — just document the rationale
  - `fieldset` needs CSS reset (`border: none; margin: 0; padding: 0;`) to avoid browser defaults
---

## 2026-02-18 - US-010
- Decomposed monolithic `src/pages/MRDetailPage.tsx` (641 lines) into `src/pages/MRDetailPage/` directory with 7 focused files
- Created orchestrator `index.tsx` (286 lines) that wires hooks and sub-components together
- Extracted components:
  - `MRHeader.tsx` (78 lines) — top bar with back button, MR info, approval button, mobile toggle
  - `MRDiffContent.tsx` (131 lines) — main content area with overlays, image diff, Monaco diff
  - `MRFilePanel.tsx` (50 lines) — sidebar with file navigation and mobile backdrop
- Extracted hooks:
  - `useMRData.ts` (146 lines) — MR data loading, file classification, and mr-updated event listener
  - `useMRKeyboard.ts` (126 lines) — all keyboard shortcuts (n/j/p/k/x/a/o/y/v/g/c/s/Escape)
  - `useFileComments.ts` (47 lines) — file comment fetching and addComment callback
  - `viewReducer.ts` (59 lines) — useReducer for 7 related view states (selectedFile, focusIndex, viewMode, collapseState, mobileSidebarOpen, viewedPaths, hideGenerated)
- Deleted old `src/pages/MRDetailPage.tsx`
- CSS stays at `src/pages/MRDetailPage.css` (imported via `../MRDetailPage.css`)
- Refactored setState-in-useEffect for initial file selection: uses render-time dispatch with ref guard instead of useEffect
- Files changed: 1 deleted, 7 created
- **Learnings for future iterations:**
  - When extracting useMRData hook that needs `clearFileCache` from `useFileContent`, use a ref (`clearFileCacheRef`) to break the circular dependency — the hook captures the ref's `.current`, which gets wired up after useFileContent runs
  - The `initialReviewableFile` pattern (returning first reviewable from data load) avoids the anti-pattern of `useEffect(() => setState(files[0]), [files])` — the orchestrator applies it during render with a ref guard
  - For view state reducers, `Set<string>` fields (like viewedPaths) need `new Set(prev).add(value)` to trigger re-renders — spreading doesn't work on Sets
  - The keyboard handler hook takes callbacks as options object rather than refs — keeps the orchestrator cleaner and the hook self-contained
---

## 2026-02-18 - US-011
- Decomposed monolithic `src/pages/MyMRDetailPage.tsx` (679 lines) into `src/pages/MyMRDetailPage/` directory with 10 focused files
- Created orchestrator `index.tsx` (129 lines) that wires hooks and sub-components together
- Extracted components:
  - `OverviewTab.tsx` (112 lines) — details, description, approvals, merge section
  - `CommentsTab.tsx` (53 lines) — discussion threads display
  - `CodeTab.tsx` (106 lines) — file navigation + diff viewer
  - `MergeSection.tsx` (146 lines) — merge status display, merge/rebase actions
- Extracted hooks:
  - `useMyMRData.ts` (73 lines) — MR, reviewers, comments loading + thread grouping
  - `useCodeTab.ts` (161 lines) — lazy code tab data loading, file navigation, file content
  - `useMyMRKeyboard.ts` (85 lines) — all keyboard shortcuts using ref pattern
  - `mergeReducer.ts` (60 lines) — useReducer for 6 merge-related states
  - `utils.ts` (29 lines) — shared utility functions (formatRelativeTime, reviewerStatusClass)
- Deleted old `src/pages/MyMRDetailPage.tsx`
- CSS stays at `src/pages/MyMRDetailPage.css` (imported via `../MyMRDetailPage.css`)
- Files changed: 1 deleted, 10 created
- **Learnings for future iterations:**
  - Merge state (merging, mergeError, mergeConfirm, mergeStatus, mergeStatusLoading, rebasing) is a natural fit for useReducer — all 6 states are tightly coupled in merge/rebase workflows
  - The MergeSection component owns its own fetchMergeStatus effect and merge/rebase handlers — cleaner than lifting all merge logic to the orchestrator
  - `ImageDiffViewer` expects `string` for base64 props but `useFileContent` returns `string | null` — use `?? ''` to coerce at the call site
  - The keyboard hook uses a single ref for options (`optionsRef.current = options`) updated on every render — simpler than the split ref pattern used in MRDetailPage
  - `setMr` needs to be exposed from `useMyMRData` so `MergeSection` can update MR state to 'merged' after successful merge
---

## 2026-02-18 - US-012
- Decomposed monolithic `src/pages/PipelinesPage.tsx` (670 lines) into `src/pages/PipelinesPage/` directory with 7 focused files
- Created orchestrator `index.tsx` (143 lines) that wires the hook and sub-components together
- Extracted components:
  - `ProjectCard.tsx` (104 lines) — single pipeline project card with status badge, actions, meta
  - `ProjectSearch.tsx` (148 lines) — search bar with debounced API search, keyboard shortcut, dropdown
- Extracted hooks/data:
  - `usePipelinesData.ts` (193 lines) — all data loading, polling, notification events, and action handlers
  - `pipelinesReducer.ts` (69 lines) — useReducer for 7 related pipeline states (instances, selectedInstanceId, projects, statuses, loading, statusesLoading, lastFetched)
  - `utils.ts` (42 lines) — formatRelativeTime, statusLabel, formatDuration
  - `icons.tsx` (47 lines) — PinIcon, RemoveIcon, SearchIcon, ExternalLinkIcon, BranchIcon
- Deleted old `src/pages/PipelinesPage.tsx`
- CSS stays at `src/pages/PipelinesPage.css` (imported via `../PipelinesPage.css`)
- Consolidated 7 useState calls into a single useReducer with `PROJECTS_LOADED` batch action to avoid multi-setState patterns
- Files changed: 1 deleted, 7 created
- **Learnings for future iterations:**
  - The `PROJECTS_LOADED` action is key — it sets projects, statuses, loading, statusesLoading, and lastFetched in one dispatch, eliminating the multi-setState-in-useEffect pattern
  - Pipeline notification emission (emitPipelineChanges) uses refs for both statuses and projects to avoid stale closures in the polling callback chain
  - The adaptive polling (30s active / 120s idle) uses statusesRef.current inside getInterval() to get fresh status data without re-creating the effect
  - Search state stays local to ProjectSearch component — it's self-contained with its own debounce, keyboard shortcut, and click-outside handling
---

## 2026-02-18 - US-013
- Decomposed monolithic `src/pages/PipelineDetailPage.tsx` (667 lines) into `src/pages/PipelineDetailPage/` directory with 9 focused files
- Created orchestrator `index.tsx` (160 lines) that wires hooks and sub-components together
- Extracted components:
  - `PipelineHeader.tsx` (64 lines) — header with back button, title, status badge, refresh/open actions
  - `JobsTab.tsx` (80 lines) — stage mini-pipeline bar + stage sections with job rows
  - `HistoryTab.tsx` (100 lines) — pipeline history listbox with keyboard navigation and auto-focus
  - `JobRow.tsx` (89 lines) — single job row with status, meta, and action buttons
- Extracted hooks/data:
  - `usePipelineData.ts` (180 lines) — jobs loading, polling, pipeline status, history loading, job actions
  - `pipelineDetailReducer.ts` (77 lines) — useReducer consolidating 8 useState calls (jobs, loading, error, actionLoading, pipelineStatus, pipelines, historyLoading, historyLoaded)
  - `utils.ts` (80 lines) — formatDuration, formatRelativeTime, jobStatusLabel, aggregateStageStatus, groupJobsByStage
  - `icons.tsx` (43 lines) — ExternalLinkIcon, PlayIcon, RetryIcon, CancelIcon, RefreshIcon
- Deleted old `src/pages/PipelineDetailPage.tsx`
- CSS stays at `src/pages/PipelineDetailPage.css` (imported via `../PipelineDetailPage.css`)
- Files changed: 1 deleted, 9 created
- **Learnings for future iterations:**
  - The `handleNavigateToJob` in the hook takes `navigate` and params as arguments rather than capturing them — avoids coupling the hook to react-router and keeps it testable
  - History tab auto-focus moved into `HistoryTab` component itself — cleaner than orchestrator managing it via effect
  - The RESET action in the reducer handles the initial load pattern (set loading true, clear previous data) in one dispatch instead of multiple setState calls
  - `Set<number>` for actionLoading works well with useReducer — ACTION_START/ACTION_END actions handle the immutable Set operations cleanly
---

## 2026-02-18 - US-014
- Decomposed `src/components/DiffViewer/DiffViewer.tsx` (575 lines) into focused sub-components and hooks
- Created orchestrator `DiffViewer.tsx` (147 lines) that wires hooks and sub-components together
- Extracted hooks:
  - `useDiffData.ts` (154 lines) — diff loading (normal + progressive), scroll handling, line selection, uses useReducer
  - `useDiffComments.ts` (113 lines) — comment loading, adding, and grouping by line
  - `useDiffKeyboard.ts` (109 lines) — keyboard shortcuts (c/Escape/]/[/x) with ref pattern
  - `diffViewerReducer.ts` (102 lines) — useReducer consolidating 9 useState calls into typed actions
- Extracted components:
  - `DiffHeader.tsx` (44 lines) — file path, large diff indicator, unified/split toggle
  - `DiffContent.tsx` (153 lines) — virtual scrolling (react-window) and regular hunk rendering
- Pre-existing files unchanged: `DiffHunk.tsx` (234 lines), `DiffLine.tsx` (88 lines), `FileNavigation.tsx` (141 lines)
- Consolidated 9 useState calls into a single useReducer with typed actions (LOAD_START, LOAD_CONTENT, HUNKS_LOADED, etc.)
- Eliminated multi-setState pattern in loadDiff effect — LOAD_START action handles reset in one dispatch
- Used refs for progressive loading state (loadedRangesRef, loadingHunksRef) to avoid stale closures in loadHunkRange callback
- Files changed: 1 rewritten (DiffViewer.tsx), 5 created (diffViewerReducer.ts, useDiffData.ts, useDiffComments.ts, useDiffKeyboard.ts, DiffHeader.tsx, DiffContent.tsx)
- **Learnings for future iterations:**
  - For progressive loading with `Set<number>` state, refs are needed alongside the reducer to avoid stale closures — the `loadHunkRange` callback checks refs for fresh values while dispatching to the reducer for state updates
  - The `react-window` `List` component with `RowComponentProps<T>` generic type works well when extracted to a separate file — just re-export the types
  - DiffViewer is not actually used by any consumer (MR pages use MonacoDiffViewer instead) — but restructuring it still improves maintainability and sets a pattern for the codebase
  - The keyboard hook uses a single `optionsRef` pattern (update `.current` every render) — simpler than the split ref approach
---

## 2026-02-18 - US-015
- Consolidated useState calls into useReducer in 5 files:
  - `CommentPanel.tsx`: 5 useState → useReducer with 8 action types (FETCH_START/SUCCESS/ERROR, SUBMIT_START/END, REPLY_START/END, SET_ERROR)
  - `InstanceSetup.tsx`: 6 useState → useReducer with SET_FIELD (typed field union), SUBMIT_START/SUCCESS/ERROR/END
  - `JobLogPage.tsx`: 6 useState → useReducer with TRACE_LOADED, LOAD_ERROR/END, STATUS_CHANGED, TOGGLE_FOLLOW/SET_FOLLOW, TOGGLE_SECTION/INIT_COLLAPSED
  - `MRList.tsx`: 6 useState → useReducer with FETCH_START (background flag), FETCH_SUCCESS (batches mrs/newMrIds/timestamp), FETCH_ERROR, SYNC_IDLE, CLEAR_NEW_MRS
  - `ThemeProvider.tsx`: 3 useState → useReducer with INIT (batches theme/uiFont/customColors in one dispatch), SET_THEME, SET_UI_FONT, SAVE_CUSTOM, DELETE_CUSTOM
- Files changed: `CommentPanel.tsx`, `InstanceSetup.tsx`, `JobLogPage.tsx`, `MRList.tsx`, `ThemeProvider.tsx`
- **Learnings for future iterations:**
  - For form components like InstanceSetup, a `SET_FIELD` action with a typed `field` union (`'url' | 'token' | 'name'`) using computed property names (`[action.field]: action.value`) is cleaner than per-field actions
  - The key benefit of useReducer in MRList is the FETCH_SUCCESS action — it batches 5 setState calls (mrs, loading, lastSyncedAt, syncStatus, newMrIds) into one dispatch, eliminating the multi-setState pattern
  - ThemeProvider's INIT action eliminates 3 separate setState calls in the mount useEffect — all resolved values are computed first, then dispatched in one action
  - `Set<string>` fields in reducers need `new Set(state.field)` to create a copy before mutation, same pattern as in earlier story reducers
  - The tick useState for MRList's sync time display (`const [, setTick] = useState(0)`) stays separate since it's genuinely unrelated to the data state
---

## 2026-02-18 - US-016
- Converted clickable div/span elements to semantic buttons or added keyboard accessibility across 10 files
- **Converted to `<button>`:**
  - `JobLogPage.tsx`: `.log-section-header` div → `<button>` with `aria-expanded`
  - `PipelineDetailPage/JobRow.tsx`: `.pipeline-job-info--clickable` div → `<button>`
- **Added `role`/keyboard handlers to existing divs:**
  - `KeyboardHelp.tsx`: overlay div → `role="button"` + `onKeyDown` + `tabIndex={0}` + `aria-label`
  - `CommandPalette.tsx`: overlay div → `role="button"` + `onKeyDown` + `tabIndex={0}` + `aria-label`
  - `CommandPalette.tsx`: command items → `role="option"` + `aria-selected` + `onKeyDown` + `tabIndex={-1}`
  - `CommandItem.tsx`: wrapper div → added `onKeyDown` + `tabIndex={-1}` (already had `role="option"`)
  - `ReAuthPrompt.tsx`: overlay div → added `onKeyDown` (already had `role="dialog"`)
  - `MRFilePanel.tsx`: backdrop div → `role="button"` + `onKeyDown` + `tabIndex={0}` + `aria-label`
- **Added ARIA to ImageDiffViewer:**
  - Swipe handle div → `role="slider"` + `aria-label` + `aria-valuemin/max/now` + `tabIndex={0}` + `onKeyDown` (ArrowLeft/Right keyboard control)
- **CSS button resets:**
  - `JobLogPage.css`: added `button.log-section-header` reset (border, font, color, text-align, width)
  - `PipelineDetailPage.css`: added `button.pipeline-job-info--clickable` reset
- Files changed: `CommandPalette.tsx`, `CommandItem.tsx`, `KeyboardHelp.tsx`, `ReAuthPrompt.tsx`, `ImageDiffViewer.tsx`, `MRFilePanel.tsx`, `JobRow.tsx`, `JobLogPage.tsx`, `JobLogPage.css`, `PipelineDetailPage.css`
- **Learnings for future iterations:**
  - Overlay/backdrop divs should get `role="button"` + `onKeyDown` + `tabIndex={0}` + `aria-label` when they have onClick — even though keyboard Escape is already handled, the click handler itself needs keyboard parity
  - Command palette items inside a listbox use `role="option"` + `tabIndex={-1}` (not `role="button"`) since the parent manages focus
  - Swipe/drag handles benefit from `role="slider"` with arrow key control rather than `role="button"` — slider gives the right semantics and allows fine-grained keyboard interaction
  - When converting a `<div>` to `<button>`, always add CSS reset: `border: none; font: inherit; color: inherit; text-align: left;` (and `width: 100%` for block-level elements)
  - The ReAuthPrompt already had `role="dialog"` which is correct — just needed `onKeyDown` for the backdrop click parity
---
