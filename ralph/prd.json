{
  "project": "Ultra GitLab",
  "branchName": "ralph/pierre-diffs",
  "description": "Replace Monaco editor diff viewer with @pierre/diffs/react and @pierre/diffs/worker for lighter, purpose-built MR diff rendering",
  "userStories": [
    {
      "id": "US-001",
      "title": "Merge Playwright E2E testing infrastructure",
      "description": "As a developer, I need the Playwright testing infrastructure available on this branch so we can verify diff rendering with E2E tests.",
      "acceptanceCriteria": [
        "Merge branch claude/add-playwright-testing-Q6qK6 into the current branch",
        "Resolve any merge conflicts cleanly",
        "playwright.config.ts exists at project root",
        "e2e/ directory exists with fixtures and spec files",
        "bun install completes without errors",
        "Existing Playwright tests pass: bunx playwright test",
        "Typecheck passes (bunx tsc --noEmit)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "The Playwright branch is claude/add-playwright-testing-Q6qK6. It adds playwright.config.ts, e2e/ directory with fixtures (seed-data, seed.sql, tauri-mock, test-base) and specs (mr-detail, mr-list, my-mrs, navigation), plus a GitHub Actions workflow."
    },
    {
      "id": "US-002",
      "title": "Install @pierre/diffs and set up WorkerPoolContextProvider",
      "description": "As a developer, I need to install the Pierre Diffs package and configure the Web Worker pool so that syntax highlighting runs off the main thread.",
      "acceptanceCriteria": [
        "Run `bun i @pierre/diffs` to install the package",
        "@pierre/diffs appears in package.json dependencies",
        "Add WorkerPoolContextProvider wrapping the app's diff-viewing subtree (in App.tsx or MRDetailPage)",
        "Worker factory uses Vite pattern: () => new Worker(new URL('@pierre/diffs/worker/worker.js', import.meta.url), { type: 'module' })",
        "Use Pierre's default pool size (no poolSize override needed)",
        "Typecheck passes (bunx tsc --noEmit)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Pierre docs: https://diffs.com/docs. The worker entry point is @pierre/diffs/worker/worker.js. WorkerPoolContextProvider is imported from @pierre/diffs/react. ESM-only package — Vite handles this natively."
    },
    {
      "id": "US-003",
      "title": "Create PierreDiffViewer component with MultiFileDiff",
      "description": "As a user, I want to see file diffs rendered with syntax highlighting so I can review merge request changes.",
      "acceptanceCriteria": [
        "Create src/components/PierreDiffViewer/PierreDiffViewer.tsx",
        "Create src/components/PierreDiffViewer/index.ts barrel export",
        "Uses <MultiFileDiff> from @pierre/diffs/react with oldFile and newFile props",
        "Props: oldContent (string | null), newContent (string | null), filePath (string), viewMode ('split' | 'unified'), mrIid and sha for cacheKey",
        "FileContents.name set to filePath for language auto-detection by Pierre",
        "FileContents.cacheKey set to `${mrIid}:${filePath}:${sha}` for worker cache hits",
        "options.diffStyle maps viewMode prop to 'split' or 'unified'",
        "options.lineDiffType set to 'word' for inline word-level change highlighting",
        "options.expandUnchanged set to true",
        "options.theme set to { dark: 'pierre-dark', light: 'pierre-light' }",
        "options.themeType set to 'system' so Pierre follows OS light/dark preference automatically",
        "Handles new files (oldContent is null — pass empty string) and deleted files (newContent is null — pass empty string) gracefully",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Pierre docs: https://diffs.com/docs. MultiFileDiff takes { oldFile: FileContents, newFile: FileContents } where FileContents is { name: string, contents: string, cacheKey?: string }. For new files, oldFile.contents should be empty string. For deleted files, newFile.contents should be empty string. Pierre uses Shadow DOM — app CSS won't leak in."
    },
    {
      "id": "US-004",
      "title": "Wire PierreDiffViewer into MRDiffContent and remove old refs",
      "description": "As a developer, I need to update MRDiffContent to render PierreDiffViewer instead of MonacoDiffViewer and clean up all MonacoDiffViewerRef usage from parent components.",
      "acceptanceCriteria": [
        "MRDiffContent.tsx imports PierreDiffViewer instead of MonacoDiffViewer",
        "PierreDiffViewer receives oldContent from fileContent.original and newContent from fileContent.modified",
        "PierreDiffViewer receives filePath from selectedFile, viewMode from current view state",
        "ImageDiffViewer still renders for image files (unchanged)",
        "MRDetailPage no longer creates or passes diffViewerRef",
        "Remove any 'next change' / 'previous change' buttons or keyboard shortcut handlers that call diffViewerRef methods",
        "Remove view state persistence logic (saveViewState/restoreViewState, viewStatesRef map) from MRDetailPage",
        "No remaining references to MonacoDiffViewerRef type anywhere in the codebase",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "MRDiffContent is at src/pages/MRDetailPage/MRDiffContent.tsx. MRDetailPage is at src/pages/MRDetailPage/index.tsx. The viewStatesRef is a Map<string, IDiffEditorViewState> used to save/restore scroll position per file — drop it entirely, Pierre components mount/unmount per file switch."
    },
    {
      "id": "US-005",
      "title": "Migrate inline comments to Pierre annotations",
      "description": "As a user, I want to see inline MR comments displayed directly in the diff so I can follow review discussions in context.",
      "acceptanceCriteria": [
        "Map existing LineComment[] data to Pierre's DiffLineAnnotation<T>[] format",
        "Each annotation has correct side ('deletions' for old side, 'additions' for new side) and lineNumber",
        "Pass lineAnnotations prop to PierreDiffViewer → MultiFileDiff",
        "Implement renderAnnotation prop that returns a React node showing comment thread (author, timestamp, body)",
        "Comments appear inline below the annotated line in the diff",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Pierre's DiffLineAnnotation type: { side: 'deletions' | 'additions', lineNumber: number, metadata: T }. The renderAnnotation callback receives the annotation and returns a ReactNode. Check existing useFileComments hook and LineComment type in src/types/index.ts for the current data shape."
    },
    {
      "id": "US-006",
      "title": "Wire up line number click for adding comments",
      "description": "As a user, I want to click a line number in the diff to start adding a new comment on that line.",
      "acceptanceCriteria": [
        "Configure onLineNumberClick in PierreDiffViewer options",
        "Clicking a line number triggers the existing add-comment flow (opens comment input at that line)",
        "Line number, side (old/new mapped to deletions/additions), and file path passed to comment creation handler",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "onLineNumberClick receives { lineNumber, side, ... } from Pierre. Map Pierre's 'deletions'/'additions' sides to the existing comment system's old/new line concept. Check existing addComment handler in MRDetailPage."
    },
    {
      "id": "US-007",
      "title": "Enable line selection in PierreDiffViewer",
      "description": "As a user, I want to select line ranges in the diff so I can reference specific code in comments or copy selections.",
      "acceptanceCriteria": [
        "Set enableLineSelection: true in Pierre options",
        "Wire onLineSelected callback to update component state with the selected SelectedLineRange",
        "Selected lines are visually highlighted in the diff (Pierre handles this automatically)",
        "Selected range information available for use by comment creation or copy actions",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Pierre's SelectedLineRange: { start: number, side?: 'deletions' | 'additions', end: number, endSide?: 'deletions' | 'additions' }. The selectedLines prop can be used for programmatic control."
    },
    {
      "id": "US-008",
      "title": "Remove Monaco dependencies and component files",
      "description": "As a developer, I want to remove all Monaco-related code and the old custom DiffViewer components to reduce bundle size and eliminate dead code.",
      "acceptanceCriteria": [
        "Run `bun remove monaco-editor @monaco-editor/react vite-plugin-monaco-editor`",
        "Delete entire src/components/Monaco/ directory (MonacoDiffViewer.tsx, MonacoProvider.tsx, languageDetection.ts, monaco.css, index.ts) — BUT keep ImageDiffViewer and move it first",
        "Delete entire src/components/DiffViewer/ directory (DiffViewer.tsx, DiffContent.tsx, DiffHunk.tsx, DiffLine.tsx, DiffHeader.tsx, useDiffData.ts, useDiffComments.ts, useDiffKeyboard.ts)",
        "Remove monacoAdapter.ts from src/themes/ or remove Monaco-specific parts",
        "Remove vite-plugin-monaco-editor from vite.config.ts plugin array if referenced",
        "Remove MonacoProvider from any component tree (likely in App.tsx or a layout)",
        "Remove all unused Monaco imports and type references across the codebase",
        "No remaining references to 'monaco-editor' or '@monaco-editor' in any .ts/.tsx file",
        "ImageDiffViewer is preserved and still works for image file diffs (move to src/components/ImageDiffViewer/ before deleting Monaco directory)",
        "Typecheck passes (bunx tsc --noEmit)",
        "Rust backend still compiles (cargo check in src-tauri/)"
      ],
      "priority": 8,
      "passes": false,
      "notes": "IMPORTANT: ImageDiffViewer (src/components/Monaco/ImageDiffViewer.tsx) is independent of Monaco — it's a pure React component for image comparison. It must NOT be deleted. Move it to src/components/ImageDiffViewer/ before deleting the Monaco directory. Update MRDiffContent.tsx import path accordingly."
    },
    {
      "id": "US-009",
      "title": "Add Playwright E2E tests for Pierre diff rendering",
      "description": "As a developer, I want Playwright tests that verify diff files render correctly with no console errors, so we can catch regressions in the diff viewer.",
      "acceptanceCriteria": [
        "Create e2e/pierre-diff.spec.ts with tests for the diff viewer",
        "Test: Navigate to an MR detail page, select a file, verify the Pierre diff component renders (shadow DOM host element visible)",
        "Test: Verify diff content is visible — at least one line of code text is rendered inside the diff",
        "Test: Verify no console errors are emitted during diff rendering (capture console messages, assert zero 'error' level entries)",
        "Test: Verify no console warnings related to Pierre/Shiki/worker (filter for relevant warning patterns)",
        "Test: Switch between split and unified view modes, verify the diff re-renders without errors",
        "Test: Select a different file from the file list, verify the new diff renders without errors",
        "Test: Verify new files (additions only) and deleted files (deletions only) render without errors",
        "All new tests pass: bunx playwright test e2e/pierre-diff.spec.ts",
        "Existing Playwright tests still pass: bunx playwright test",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Pierre renders inside Shadow DOM, so use page.locator('pierce/...') or evaluate into shadowRoot to assert on diff content. Use page.on('console', ...) to capture console messages and filter by level. The existing e2e/fixtures/tauri-mock.ts and test-base.ts provide the test harness — follow the patterns in existing spec files (e2e/mr-detail.spec.ts) for navigating to MR detail pages."
    }
  ]
}
