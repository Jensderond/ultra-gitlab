{
  "project": "Ultra GitLab",
  "branchName": "ralph/frontend-health",
  "description": "Frontend Health Improvements - Fix react-doctor errors, decompose giant components, improve accessibility, and remove dead code to raise score from 83 to 90+",
  "userStories": [
    {
      "id": "US-001",
      "title": "Remove dangerouslySetInnerHTML in Settings",
      "description": "As a developer, I want to eliminate the XSS risk in Settings so that the app does not render unsanitized HTML.",
      "acceptanceCriteria": [
        "dangerouslySetInnerHTML at src/pages/Settings.tsx:767 is replaced with safe text rendering or a sanitization approach",
        "The rendered output is visually identical to before",
        "Typecheck passes (bunx tsc --noEmit)"
      ],
      "priority": 1,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Extract companion auth checks into shared hook",
      "description": "As a developer, I want the duplicated companion-server auth checks consolidated into a reusable hook so the fetch-in-useEffect pattern is encapsulated.",
      "acceptanceCriteria": [
        "Create a useCompanionAuth() hook (or similar) in src/hooks/ that encapsulates the fetch('/api/instances') session check logic",
        "src/App.tsx:62 uses the shared hook instead of inline fetch-in-useEffect",
        "src/pages/AuthPage.tsx:24 uses the shared hook instead of inline fetch-in-useEffect",
        "Loading and redirect states are preserved — behavior unchanged",
        "These are browser-mode companion-server auth guards, NOT data fetching — do NOT add tanstack query",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Fix derived state and event handler simulation in CommandPalette",
      "description": "As a developer, I want derived state computed during render and event-simulating useEffects moved to actual handlers in CommandPalette.",
      "acceptanceCriteria": [
        "src/components/CommandPalette/CommandPalette.tsx:121 — useEffect computing derived state replaced with inline computation during render (const derived = computeFrom(dep))",
        "src/components/CommandPalette/CommandPalette.tsx:126 — useEffect simulating event handler moved to actual event handler",
        "Behavior is unchanged — command palette filters and responds identically",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Fix array-index keys across codebase",
      "description": "As a developer, I want list items to use stable unique keys so React reconciliation works correctly when lists are reordered or filtered.",
      "acceptanceCriteria": [
        "src/components/CommandPalette/CommandItem.tsx:31 — index key replaced with stable ID (e.g., item.id or item.label)",
        "src/pages/Settings.tsx:925 — index key replaced with stable ID",
        "src/components/DiffViewer/DiffViewer.tsx:547, 557 — index keys replaced with stable IDs (e.g., line number, hunk id)",
        "src/pages/JobLogPage.tsx:61, 62, 375, 380 — index keys replaced with stable IDs",
        "No visual or behavioral regressions",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Remove dead source files",
      "description": "As a developer, I want confirmed dead source files removed so the codebase is cleaner and has no misleading unused code.",
      "acceptanceCriteria": [
        "src/hooks/useSyncStatus.ts — removed (confirmed unused)",
        "src/themes/index.ts — removed (confirmed unused)",
        "src/components/InstanceSetup/index.ts — removed (confirmed unused)",
        "src/components/Monaco/collapseRegions.ts — removed (confirmed unused)",
        "src/components/SyncStatus/PendingActionsIndicator.tsx — removed (confirmed unused)",
        "src/components/SyncStatus/SyncLogPanel.tsx — removed (confirmed unused)",
        "src/components/SyncStatus/SyncStatusBar.tsx — removed (confirmed unused)",
        "src/components/SyncStatus/index.ts — removed (confirmed unused)",
        "Also remove any associated CSS files for the deleted components (e.g., SyncStatusBar.css, PendingActionsIndicator.css, SyncLogPanel.css)",
        "No import errors after removal — verify no other file imports from these modules",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Fix barrel import in InlineComment",
      "description": "As a developer, I want direct imports used instead of barrel imports for better tree-shaking.",
      "acceptanceCriteria": [
        "src/components/CommentPanel/InlineComment.tsx:8 — barrel/index import replaced with direct module path",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Extract inline render functions and fix useState initializer",
      "description": "As a developer, I want inline render functions extracted to named components and useState lazy initializer added where needed.",
      "acceptanceCriteria": [
        "src/components/DiffViewer/DiffLine.tsx:122 — renderHighlightedContent() extracted to a named component (e.g., HighlightedContent)",
        "src/pages/JobLogPage.tsx:74 — inline render function extracted to a named component",
        "src/pages/JobLogPage.tsx:139 — useState(has()) changed to useState(() => has()) for lazy initialization",
        "Remove unnecessary useMemo at src/pages/MyMRDetailPage.tsx:192 and 199 — these wrap trivially cheap expressions",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Break up Settings page — extract sub-components",
      "description": "As a developer, I want the Settings page decomposed into focused sub-components so it is easier to maintain.",
      "acceptanceCriteria": [
        "Create src/pages/Settings/ directory with index.tsx as the orchestrator",
        "Extract logical sections into separate files (e.g., InstanceSettings.tsx, ThemeSettings.tsx, CompanionServerSection.tsx, etc.)",
        "Each sub-component is under ~150 lines",
        "The parent Settings orchestrator imports and renders all sub-components",
        "All existing Settings functionality works identically",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Fix Settings accessibility — labels, autoFocus, event handlers",
      "description": "As a developer, I want Settings accessibility issues fixed now that the page is decomposed into manageable sub-components.",
      "acceptanceCriteria": [
        "Labels at former lines 431, 780, 1484 are associated with their controls via htmlFor or by wrapping the control",
        "useEffect simulating event handler (former line 1325) moved to an actual event handler",
        "autoFocus at former lines 360, 935, 1245 reviewed — removed if not essential, kept with justification comment if needed (e.g., modal focus trap)",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "This story depends on US-008 (Settings decomposition). Line numbers refer to the original Settings.tsx before decomposition — find the equivalent code in the new sub-components."
    },
    {
      "id": "US-010",
      "title": "Break up MRDetailPage into sub-components",
      "description": "As a developer, I want MRDetailPage decomposed into focused sub-components so the file is easier to navigate and modify.",
      "acceptanceCriteria": [
        "Create src/pages/MRDetailPage/ directory with index.tsx as orchestrator",
        "Extract logical sections (e.g., MRHeader, MRFileList, MRDiscussion) into separate files",
        "Multiple useState calls consolidated into useReducer where state is related",
        "Multiple setState-in-useEffect instances refactored (derive state during render or move to event handlers)",
        "Each sub-component is under ~200 lines",
        "All existing MR detail functionality works identically",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Break up MyMRDetailPage into sub-components",
      "description": "As a developer, I want MyMRDetailPage decomposed into focused sub-components.",
      "acceptanceCriteria": [
        "Create src/pages/MyMRDetailPage/ directory with index.tsx as orchestrator",
        "Extract logical sections into separate files",
        "Multiple useState calls consolidated into useReducer where state is related",
        "Multiple setState-in-useEffect instances refactored",
        "Each sub-component is under ~200 lines",
        "All existing My MR detail functionality works identically",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Break up PipelinesPage into sub-components",
      "description": "As a developer, I want PipelinesPage decomposed into focused sub-components.",
      "acceptanceCriteria": [
        "Create src/pages/PipelinesPage/ directory with index.tsx as orchestrator",
        "Extract logical sections into separate files",
        "Multiple useState calls consolidated into useReducer where state is related",
        "setState-in-useEffect instances refactored",
        "Each sub-component is under ~200 lines",
        "All existing pipelines functionality works identically",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Break up PipelineDetailPage into sub-components",
      "description": "As a developer, I want PipelineDetailPage decomposed into focused sub-components.",
      "acceptanceCriteria": [
        "Create src/pages/PipelineDetailPage/ directory with index.tsx as orchestrator",
        "Extract logical sections into separate files",
        "Multiple useState calls consolidated into useReducer where state is related",
        "Multiple setState-in-useEffect instances refactored",
        "Each sub-component is under ~200 lines",
        "All existing pipeline detail functionality works identically",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Break up DiffViewer into sub-components",
      "description": "As a developer, I want DiffViewer decomposed into focused sub-components.",
      "acceptanceCriteria": [
        "Restructure src/components/DiffViewer/ with smaller focused files",
        "Multiple useState calls consolidated into useReducer where state is related",
        "setState-in-useEffect at line 142 refactored",
        "Use React context for shared state if sub-components are deeply nested",
        "Each sub-component is under ~200 lines",
        "All existing diff viewing functionality works identically",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Consolidate useState in CommentPanel, InstanceSetup, JobLogPage, MRList",
      "description": "As a developer, I want components with 5+ useState calls to use useReducer for related state.",
      "acceptanceCriteria": [
        "src/components/CommentPanel/CommentPanel.tsx:46 — related useState calls grouped into useReducer",
        "src/components/InstanceSetup/InstanceSetup.tsx:21 — related useState calls grouped into useReducer",
        "src/pages/JobLogPage.tsx:112 — related useState calls grouped into useReducer",
        "src/components/MRList/MRList.tsx:50 — related useState calls grouped into useReducer",
        "Multi-setState useEffect in src/components/ThemeProvider.tsx:211 consolidated into single dispatch",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Convert clickable divs to semantic buttons for accessibility",
      "description": "As a developer, I want all clickable non-interactive elements converted to semantic HTML (button) which simultaneously fixes keyboard accessibility, ARIA roles, and click handling.",
      "acceptanceCriteria": [
        "All 12 flagged clickable elements converted from div/span onClick to <button> elements (or given role='button' + onKeyDown if button is not viable)",
        "Files to update: KeyboardHelp, CommandPalette, CommandItem, ReAuthPrompt, Settings sub-components, PipelinesPage, MRDetailPage, JobLogPage, PipelineDetailPage",
        "Note: PendingActionsIndicator was deleted in US-005 — skip it",
        "Note: ImageDiffViewer (src/components/Monaco/ImageDiffViewer.tsx:202, 227) also needs role attributes added",
        "Keyboard interaction (Enter/Space) works on all converted elements",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "This depends on US-008 through US-014 (component decomposition). Work with the new sub-component files, not the original monolithic files."
    },
    {
      "id": "US-017",
      "title": "Review and remove unnecessary autoFocus usage",
      "description": "As a developer, I want autoFocus usage reviewed so it does not harm accessibility.",
      "acceptanceCriteria": [
        "src/components/CommentPanel/InlineComment.tsx:166 — autoFocus reviewed; removed if not essential",
        "src/components/InstanceSetup/InstanceSetup.tsx:78 — autoFocus reviewed; removed if not essential",
        "Any retained autoFocus has a comment justifying it (e.g., // autoFocus: modal focus trap)",
        "Note: Settings autoFocus instances handled in US-009",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    }
  ]
}
